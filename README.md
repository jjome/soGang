# 소강 (SoGang) - 멀티플레이어 카드 게임

## 📋 프로젝트 개요

소강은 "The Gang" 카드 게임을 기반으로 한 실시간 멀티플레이어 웹 게임입니다. Node.js, Express, Socket.io를 사용하여 실시간 통신을 구현하고, SQLite 데이터베이스로 사용자 데이터와 게임 상태를 관리합니다.

### "The Gang" 게임 소개
The Gang은 협동형 포커 게임으로, 플레이어들이 전문 도둑 그룹이 되어 3번의 금고를 털어야 하는 게임입니다. 일반적인 포커와 달리 **협동**이 핵심이며, 블러핑은 금지됩니다. 플레이어들은 칩을 통해서만 소통하며, 자신의 핸드 강도를 상대적으로 평가해야 합니다.

## 🎯 주요 기능

### 🔐 사용자 인증 시스템
- 회원가입 및 로그인
- 세션 기반 인증
- 관리자 권한 시스템
- 비밀번호 암호화 (bcryptjs)

## 🎮 게임 시스템
- **The Gang 카드 게임**: 3-6명 플레이어 지원의 협동형 포커 게임
- 실시간 멀티플레이어 게임
- 방 생성 및 참가
- 실시간 게임 상태 동기화
- 턴 기반 게임 진행 (4라운드: Pre-Flop, Flop, Turn, River)

### 🎯 게임 목표 및 규칙
- **승리 조건**: 3개의 금고를 성공적으로 털기 (3번의 성공적인 하이스트)
- **패배 조건**: 3번의 경보 발생
- **핵심 원칙**: 
  - 협동: 모든 플레이어가 함께 승리하거나 패배
  - 소통 제한: 직접적인 카드 정보 공유 금지, 칩을 통한 간접적 소통만 허용
  - 블러핑 금지: 정확한 핸드 평가가 필수

### 🃏 게임 진행 과정
각 하이스트는 4라운드로 구성:
1. **Round 1 (Pre-Flop)**: 각 플레이어에게 포켓카드 2장 배분 → 화이트 칩 선택
2. **Round 2 (Flop)**: 커뮤니티 카드 3장 공개 → 옐로우 칩 선택  
3. **Round 3 (Turn)**: 커뮤니티 카드 1장 추가 → 오렌지 칩 선택
4. **Round 4 (River)**: 커뮤니티 카드 1장 추가 → 레드 칩 선택
5. **Showdown**: 레드 칩 순서대로 핸드 공개 및 검증

### 🎲 칩 시스템
- 칩의 별 개수(1-6)로 자신의 핸드 상대적 강도를 표현
- 가장 높은 별 = 가장 강한 핸드, 1별 = 가장 약한 핸드
- 같은 색깔 칩은 한 개만 소유 가능
- 다른 플레이어의 칩도 가져올 수 있음

### 🏠 게임 방 관리
- 방 생성 및 참가
- 플레이어 대기실
- 실시간 플레이어 목록
- 방 설정 (최대 플레이어 수 등)

### 👑 관리자 기능
- 사용자 관리
- 게임 통계 및 모니터링
- 시스템 설정 관리

## 🏗️ 기술 스택

### Backend
- **Node.js** (v18.0.0+)
- **Express.js** - 웹 서버 프레임워크
- **Socket.io** - 실시간 통신
- **SQLite3** - 데이터베이스
- **Express-session** - 세션 관리
- **bcryptjs** - 비밀번호 암호화

### Frontend
- **HTML5/CSS3** - 게임 인터페이스
- **JavaScript (ES6+)** - 클라이언트 로직
- **Socket.io Client** - 실시간 통신

### 개발 도구
- **Nodemon** - 개발 서버 자동 재시작
- **Cross-env** - 환경 변수 관리

## 📁 프로젝트 구조

```
soGang/
├── src/                    # 소스 코드
│   ├── app.js             # Express 앱 설정
│   ├── config/            # 설정 파일
│   ├── controllers/       # 컨트롤러
│   ├── middleware/        # 미들웨어
│   └── routes/            # API 라우트
├── public/                # 정적 파일
│   ├── game.html          # 메인 게임 페이지
│   ├── login.html         # 로그인 페이지
│   ├── admin.html         # 관리자 페이지
│   └── style.css          # 스타일시트
├── data/                  # 데이터베이스 파일
├── sessions/              # 세션 저장소
├── database.js            # 데이터베이스 설정
├── socketHandlers.js      # Socket.io 이벤트 핸들러
├── index.js               # 서버 진입점
└── package.json           # 프로젝트 설정
```

## 🚀 설치 및 실행

### 1. 의존성 설치
```bash
npm install
```

### 2. 개발 서버 실행
```bash
npm run dev
```

### 3. 프로덕션 서버 실행
```bash
npm start
```

### 4. 접속
- 게임: `http://localhost:3000`
- 관리자: `http://localhost:3000/admin`
- 로그인: `http://localhost:3000/login.html`

## 🎲 게임 규칙

### The Gang 카드 게임 상세 규칙
- **기본 게임 모드**: 표준 52장 카드덱 사용
- **고급 게임 모드**: 
  - **Advanced Mode**: 스페셜리스트 카드와 챌린지 카드 추가
  - **Professional Mode**: 게임 전체에 영향을 주는 챌린지 카드
  - **Master Thief Mode**: 2번의 경보로 패배, 항상 2개의 챌린지 카드 활성

### 📊 포커 핸드 랭킹 (약함→강함 순서)
1. **하이 카드** (High Card)
2. **원 페어** (One Pair)  
3. **투 페어** (Two Pair)
4. **쓰리 오브 어 카인드** (Three of a Kind)
5. **스트레이트** (Straight)
6. **플러시** (Flush)
7. **풀 하우스** (Full House)
8. **포 오브 어 카인드** (Four of a Kind)
9. **스트레이트 플러시** (Straight Flush)
10. **로열 플러시** (Royal Flush)

### 🎴 특수 카드 시스템
- **챌린지 카드**: 게임을 더 어렵게 만드는 제약 조건들
  - Quick Access, Noise Sensors, Motion Detector, Retina Scan 등
- **스페셜리스트 카드**: 게임을 쉽게 해주는 도움 능력들  
  - Informant, Getaway Driver, Hacker, Coordinator 등

## 📊 데이터베이스 스키마

### 주요 테이블
- **users**: 사용자 정보 (ID, 사용자명, 비밀번호, 점수)
- **games**: 게임 정보 (ID, 이름, 호스트, 최대 플레이어, 상태)
- **settings**: 시스템 설정

## 🔧 개발 현황

### ✅ 완료된 기능
- [x] 사용자 인증 시스템 (회원가입/로그인)
- [x] 기본 게임 방 생성 및 참가
- [x] 실시간 Socket.io 통신
- [x] The Gang 게임 로직 (1라운드)
- [x] **실시간 칩 시스템** (2025.08.25)
  - [x] 서버 권위적 칩 상태 관리
  - [x] 즉시 칩 동기화 (중복 방지)
  - [x] 칩 가져오기/교환 기능
  - [x] 실시간 칩 상태 브로드캐스트
- [x] **다중 라운드 칩 시스템** (2025.10.09)
  - [x] 라운드별 칩 잠금 메커니즘
  - [x] 이전 라운드 칩 유지 및 시각적 구분
  - [x] 현재 라운드 칩만 교환 가능
  - [x] 서버 측 칩 검증 강화
- [x] **패스 시스템** (2025.08.25)
  - [x] 플레이어별 패스 상태 관리
  - [x] 요약표에서 패스 상태 시각화 (✓/🎮 아이콘)
  - [x] 칩 상태 변경 시 패스 해제
  - [x] 모든 플레이어 패스 시 라운드 자동 종료
  - [x] 모든 라운드에서 패스 버튼 활성화 (2025.10.09)
  - [x] 패스한 플레이어 패스 버튼 비활성화 (2025.10.09)
- [x] **실시간 게임 시스템** (2025.08.25)
  - [x] 턴제 제거하여 실시간 게임으로 변경
  - [x] 언제든 칩 가져오기/패스 가능
  - [x] 다중 라운드 시스템 (최대 5라운드)
  - [x] 자동 점수 계산 및 승자 결정
- [x] 관리자 페이지 기본 구조
- [x] 데이터베이스 백업/복원 시스템
- [x] 세션 관리 및 보안
- [x] 반응형 웹 디자인

### 🚧 진행 중인 기능
- [x] 게임 진행 로직 완성 (다중 라운드) ✅ **완료 (2025.08.25)**
- [x] 게임 결과 처리 ✅ **완료 (2025.08.25)**

### ❌ 미구현 기능
- [ ] **Advanced/Professional/Master Thief Mode**: 챌린지 카드와 스페셜리스트 카드 시스템
- [ ] **완전한 쇼다운 로직**: True Tie 처리 및 킥커 카드 비교
- [ ] **게임 모드 선택**: 기본/고급/프로페셔널/마스터 도둑 모드
- [ ] **특수 카드 시스템**: 10가지 챌린지 카드와 10가지 스페셜리스트 카드 구현
- [ ] **고급 칩 시스템**: 다크 사이드 칩, 칩 소유권 제한 등
- [ ] **게임 히스토리 및 통계**: 하이스트 기록 및 성공률 추적
- [ ] **사용자 프로필 및 설정**: 개인화된 게임 설정
- [ ] **친구 시스템**: 친구 추가 및 초대 기능
- [ ] **채팅 시스템**: 게임 내 소통 (규칙 내에서)
- [ ] **게임 리플레이**: 과거 게임 재생 기능
- [ ] **모바일 앱 지원**: 반응형 모바일 인터페이스

## 🐛 알려진 버그 및 이슈

### 🔴 심각한 버그
- [ ] **게임 진행 중 연결 끊김 시 상태 불일치**: 플레이어 재연결 로직 부족
- [ ] **동시 접속 시 세션 충돌**: 세션 관리 동시성 문제
- [ ] **메모리 누수**: Socket 연결 해제 시 정리 누락
- [ ] **쇼다운 로직 불완전**: 동점 처리 및 킥커 카드 비교 미구현
- [x] **칩 시스템 검증 부족**: 잘못된 칩 선택 시 처리 미흡 ✅ **수정됨 (2025.08.25)**
- [x] **다중 라운드 칩 처리 오류**: 2라운드 이상에서 칩 시스템 작동 불가 ✅ **수정됨 (2025.10.09)**

### 🟡 중간 수준 이슈
- [x] **게임 상태 동기화 지연**: 실시간 업데이트 최적화 필요 ✅ **개선됨 (2025.08.25)**
- [x] **UI 반응성 개선**: 게임 진행 시 사용자 피드백 부족 ✅ **개선됨 (2025.08.25)**
- [ ] **에러 처리 및 사용자 피드백**: 명확한 오류 메시지 부족
- [ ] **포커 핸드 계산 정확성**: 복잡한 상황에서 핸드 랭킹 오류
- [x] **게임 룰 검증**: 규칙 위반 사항 자동 감지 부족 ✅ **개선됨 (2025.08.25)**

### 🟢 경미한 이슈
- [ ] **일부 브라우저 호환성**: 구형 브라우저 지원 제한
- [ ] **로딩 상태 표시**: 게임 로딩 중 진행상황 표시 부족
- [ ] **로그 메시지 정리**: 개발용 콘솔 로그 정리 필요
- [ ] **UI/UX 일관성**: 디자인 통일성 개선 필요

## 🚀 최신 개발 변경사항

### 📅 2025.10.11 - v2.6.1 (쇼다운 UI 개선)

#### ✨ 주요 기능 추가
1. **쇼다운 확인 시스템 개선**
   - 2라운드 이상에서 쇼다운 확인 버튼이 활성화되지 않던 버그 수정
   - `gameState.phase = 'showdown'` 저장으로 UI 상태 유지
   - 쇼다운 페이즈 동안 UI가 덮어써지지 않도록 개선

2. **금고/경보 카운터 상시 표시**
   - 게임 시작부터 금고/경보 카운터 항상 표시
   - 게임판(요약판)과 게임 중앙판 사이에 고정 배치
   - 쇼다운 시 실시간 업데이트 (innerHTML 재생성 대신 textContent 업데이트)
   - 페이드 인/아웃 효과 적용 (opacity, visibility 사용)

3. **서버 재시작 안정성 개선**
   - Windows 환경에서 `npx kill-port 3000` 사용으로 안정적인 서버 종료
   - `taskkill` 명령어 문제 해결

#### 🔧 기술적 개선사항
- `heist-score-container`를 `.players-container` 내부에서 독립적으로 배치
- CSS `display: none` 대신 `opacity`와 `visibility`로 부드러운 전환 효과
- HTML에 초기값(0) 설정하여 게임 시작 시부터 카운터 표시
- 쇼다운 종료 시 카운터를 숨기지 않고 계속 표시

#### 🐛 버그 수정
- 2라운드 이상 쇼다운에서 확인 버튼 비활성화 문제 해결
- 대기 중 표시가 수정 전 모양으로 나타나던 문제 수정
- npm 서버 재부팅 시 프로세스가 종료되지 않던 문제 해결
- 금고/경보 카운터가 쇼다운에서만 표시되던 문제 수정

---

### 📅 2025.10.09 - v2.6.0 (다중 라운드 칩 시스템)

#### ✨ 주요 기능 추가
1. **다중 라운드 칩 잠금 시스템**
   - 이전 라운드 칩 자동 잠금 처리 (`locked: true`)
   - 라운드별 칩 구분 (`round` 속성 추가)
   - 새로운 라운드 시작 시 기존 칩 유지하면서 새 칩 추가
   - 잠긴 칩은 교환/이동 불가능

2. **개선된 칩 교환 시스템**
   - 중앙 칩 가져오기: 현재 라운드 잠기지 않은 칩만 선택
   - 플레이어 간 칩 교환: 잠긴 칩 자동 필터링
   - 클라이언트 측에서 잠긴 칩 시각적 구분 (흐린 표시, 점선 테두리)
   - 서버 측 검증 강화 (라운드 및 잠금 상태 확인)

3. **패스 버튼 개선**
   - Round2, Round3, Round4 페이즈에서도 패스 버튼 활성화
   - 이미 패스한 플레이어는 패스 버튼 자동 비활성화
   - 모든 플레이어가 칩 보유 시 패스 가능

4. **커뮤니티 카드 표시 개선**
   - 중앙 칩이 모두 가져가져도 커뮤니티 카드 계속 표시
   - 빈 카드 배열 수신 시 기존 카드 유지

#### 🔧 기술적 개선사항
- `socket.data` 안전한 참조로 변경 (`socket?.data`)하여 크래시 방지
- Phase 검증 로직 확장 (round1-4, round1Complete, round2Complete 등)
- `prepareNextRound`에서 phase를 `round{N}` 형식으로 설정
- 칩 클릭 핸들러에서 `hasUnlockedChip` 조건 사용
- 플레이어 요약표에서 칩 표시 시 XSS 방지 처리

#### 🐛 버그 수정
- 2라운드 이상에서 칩 가져오기 불가능한 문제 해결
- 패스 버튼이 라운드2+에서 표시되지 않던 문제 수정
- 게임 시작 시 `socket.data` undefined 에러로 인한 크래시 해결
- 커뮤니티 카드가 중앙 칩 소진 시 사라지던 문제 해결
- 플레이어 칩 교환 시 잠긴 칩 선택되던 문제 수정

---

### 📅 2025.08.25 - v2.5.0 (실시간 칩 시스템 & 패스 기능)

#### ✨ 주요 기능 추가
1. **실시간 칩 시스템 완전 구현**
   - 서버 권위적(Server Authoritative) 칩 상태 관리
   - 칩 가져오기/교환 시 즉시 동기화 (중복 방지)
   - 다중 브로드캐스트로 확실한 상태 전파
   - 원자적(Atomic) 칩 이동 연산으로 데이터 무결성 보장

2. **패스 시스템 및 라운드 관리**
   - 개별 플레이어 패스 상태 추적
   - 요약표에서 시각적 패스 상태 표시 (✓ = 패스, 🎮 = 게임 중)
   - 칩 상태 변경 시 모든 플레이어 패스 해제
   - 모든 플레이어 패스 시 자동 라운드 종료 및 다음 라운드 진행

3. **실시간 멀티플레이어 게임으로 전환**
   - 턴제 시스템 완전 제거
   - 언제든 칩 가져오기/교환/패스 가능
   - 실시간 게임 상태 동기화
   - 다중 라운드 시스템 (최대 5라운드)

4. **게임 종료 및 승부 판정**
   - 자동 점수 계산 (칩의 별 개수 합산)
   - 승자 결정 및 최종 점수 표시
   - 게임 종료 시 로비 복귀 옵션

#### 🔧 기술적 개선사항
- 서버-클라이언트 간 게임 상태 동기화 최적화
- Socket.io 이벤트 처리 안정성 향상
- 실시간 UI 업데이트 및 사용자 피드백 개선
- 메모리 누수 방지를 위한 이벤트 정리 로직 추가

#### 🐛 버그 수정
- 칩 중복 표시 문제 해결
- 게임 상태 불일치 문제 수정
- 패스 버튼 활성화 조건 개선
- 요약표 가시성 문제 해결

## 🎯 향후 개발 계획

### 단기 목표 (1-2주)
1. **완전한 게임 로직 구현**
   - 4라운드 완전한 게임 플로우 구현
   - 쇼다운 로직 완성 (True Tie, 킥커 카드 비교)
   - 포커 핸드 랭킹 정확성 개선
   - 게임 종료 및 결과 처리

2. **핵심 버그 수정**
   - 연결 끊김 처리 개선
   - 세션 관리 안정화  
   - 메모리 누수 해결
   - 게임 상태 동기화 개선

### 중기 목표 (1-2개월)
1. **Advanced Mode 구현**
   - 10가지 챌린지 카드 시스템 구현
   - 10가지 스페셜리스트 카드 시스템 구현
   - 게임 모드 선택 UI
   - 카드별 특수 로직 구현

2. **사용자 경험 개선**
   - 게임 히스토리 시스템
   - 사용자 프로필 및 설정
   - 친구 시스템
   - 게임 내 채팅 (규칙 준수)

### 장기 목표 (3-6개월)
1. **고급 기능 구현**
   - Professional/Master Thief Mode
   - 게임 리플레이 시스템

## 🧪 테스트

### 게임 로직 테스트
- `http://localhost:3000/api-test.html` - API 엔드포인트 테스트
- `http://localhost:3000/realtime-test.html` - Socket.io 연결 테스트

### 포커 핸드 테스트
- 다양한 포커 핸드 조합 검증
- True Tie 상황 테스트
- 킥커 카드 비교 로직 검증

### 게임 시나리오 테스트
- 정상적인 하이스트 진행
- 실패 상황 (잘못된 칩 순서)
- 연결 끊김 및 재연결
- 동시 플레이어 액션

## 🎯 게임 플레이 가이드

### 초보자를 위한 팁
1. **포커 기본기**: Texas Hold'em 규칙을 미리 학습하면 도움이 됩니다
2. **협동의 중요성**: 블러핑하지 말고 정확한 핸드 평가에 집중하세요
3. **칩 시스템 이해**: 상대적 강도 표현이 핵심입니다
4. **커뮤니케이션**: 직접적인 카드 정보는 공유할 수 없지만, 칩 선택을 통해 소통하세요

### 고급 전략
- 라운드별 핸드 강도 변화 관찰
- 다른 플레이어의 칩 선택 패턴 분석  
- 커뮤니티 카드와 자신의 포켓카드 조합 최적화
- True Tie 상황에서의 칩 순서 전략

## 📝 개발 가이드

### 코드 스타일
- JavaScript ES6+ 사용
- 일관된 들여쓰기 (2칸 공백)
- 한국어 주석 사용 (게임 로직은 영어 용어 혼용 가능)
- 명확한 함수 및 변수명
- 포커 용어는 영어 원문 유지 (Flop, Turn, River 등)

### Git 커밋 규칙
- `feat:` - 새 기능 추가
- `fix:` - 버그 수정
- `docs:` - 문서 수정
- `style:` - 코드 스타일 변경
- `refactor:` - 코드 리팩토링
- `game:` - 게임 로직 관련 변경
- `ui:` - UI/UX 개선

### 게임 개발 특이사항
- 포커 핸드 랭킹 로직은 정확성이 중요
- 실시간 동기화를 위한 이벤트 순서 관리
- 클라이언트-서버 간 게임 상태 일관성 유지
- 치팅 방지를 위한 서버 사이드 검증

## 🤝 기여 방법

1. 이슈 생성 또는 기존 이슈 확인
2. 기능 브랜치 생성 (`feature/기능명`)
3. 코드 작성 및 테스트
4. Pull Request 생성
5. 코드 리뷰 및 병합

## 🎲 The Gang 원작 게임 정보

### 게임 정보
- **원작**: "The Gang: The Cooperative Poker Game"
- **디자이너**: John Cooper & Kory Heath  
- **출판사**: Kosmos / Thames & Kosmos
- **플레이어**: 3-6명
- **연령**: 10세 이상
- **플레이 타임**: 30-60분

### 게임 구성품 (원작)
- 52장 표준 플레이 카드
- 24개 칩 (4색상, 각 6개 - 1~6별)
- 3장 금고 카드 & 3장 경보 카드
- 10장 챌린지 카드 & 10장 스페셜리스트 카드
- 게임플레이 오버뷰 카드 & 핸드 랭킹 카드

### 라이선스 및 저작권
- 이 프로젝트는 "The Gang" 보드게임의 비공식 디지털 구현입니다
- 원작 게임의 모든 권리는 해당 제작사에 있습니다
- 교육 및 개인 사용 목적으로만 개발되었습니다

## 👥 개발팀

- **프로젝트 관리자**: [사용자명]
- **개발자**: [개발자명]
- **디자이너**: [디자이너명]

## 📞 연락처

- **이슈 리포트**: GitHub Issues
- **문의사항**: [이메일 주소]
- **프로젝트 홈페이지**: [URL]

---

**마지막 업데이트**: 2025년 10월 11일
**현재 버전**: v2.6.1 (쇼다운 UI 개선)
**다음 목표**: v3.0.0 (Advanced Mode 구현)

### 📝 버전 히스토리
- **v2.6.1** (2025.10.11): 쇼다운 확인 시스템 버그 수정, 금고/경보 카운터 상시 표시, 서버 재시작 안정성 개선
- **v2.6.0** (2025.10.09): 다중 라운드 칩 잠금 시스템, 패스 버튼 개선, 커뮤니티 카드 표시 수정
- **v2.5.0** (2025.08.25): 실시간 칩 시스템, 패스 기능, 다중 라운드 완성
- **v2.1.0** (2025.01): 기본 게임 모드 구현
- **v2.0.0**: The Gang 게임 로직 기초 구현
- **v1.0.0**: 기본 멀티플레이어 시스템