<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>게임 플레이 - 소강 v2.1</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            color: #e8e8e8;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .game-container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
                 .game-info {
             display: flex !important;
             flex-direction: column !important;
             background: transparent;
             padding: 0;
             border-radius: 0 0 20px 20px;
             margin-bottom: 15px;  /* 하단 간격 추가 */
             margin-top: 0;
             backdrop-filter: blur(15px);
             border: none;
             border-top: none;
             box-shadow: 0 0 30px rgba(212, 175, 55, 0.4), inset 0 0 20px rgba(212, 175, 55, 0.1), 0 8px 32px rgba(0,0,0,0.5);
             /* position: sticky 제거 - 일반 상단 배치로 변경 */
             z-index: 100;
         }
         
         .game-info-header {
             display: flex !important;
             flex-direction: row !important;
             justify-content: space-between;
             align-items: center;
             padding: 0.1rem 0;
             background: rgba(20, 20, 20, 0.95);
             border-bottom: 1px solid rgba(212, 175, 55, 0.3);
             margin-bottom: 0;
         }

        .game-info-header .room-name {
            flex: 0 0 auto;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            color: #d4af37;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .game-info-header .game-phase-center {
            flex: 1;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #d4af37;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .game-info-header #backToLobbyBtn {
            flex: 0 0 auto;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        
         

        

        
                          /* 모바일 반응형 */
         @media (max-width: 768px) {
             .game-info {
                 flex-direction: column;
                 gap: 4px;
                 padding: 4px 15px;
                 border-radius: 0 0 15px 15px;
                 margin-bottom: 0;
             }
             
             .game-info-header {
                 flex-direction: row;
                 gap: 4px;
                 padding: 0.1rem;
             }

             .game-info-header .room-name,
             .game-info-header .game-phase-center {
                 font-size: 0.9rem;
             }

             .game-info-header #backToLobbyBtn {
                 font-size: 0.85rem;
                 padding: 0.4rem 0.8rem;
             }
             
                           .all-players {
                  max-height: 30vh;
                  padding: 6px;
              }
              
              .all-player-chips-after-cards {
                  margin-left: 8px;
                  gap: 3px;
              }
              
                             .all-player-chips-after-cards .all-player-chip {
                   width: 18px;
                   height: 18px;
                   font-size: 7px;
                   background: linear-gradient(135deg, #ffffff, #f0f0f0);
                   border: 1px solid rgba(200,200,200,0.8);
                   color: #333;
                   text-shadow: 0 1px 2px rgba(255,255,255,0.8);
                   box-shadow: 0 1px 4px rgba(255, 255, 255, 0.6);
               }
               
               /* 모바일에서 커뮤니티 카드 크기 조정 */
               .community-cards {
                   gap: 4px;
                   margin: 3px 0;
                   flex-wrap: nowrap;
               }
               
               .card {
                   width: 48px;
                   height: 72px;
                   font-size: 0.8rem;
               }
               
               /* 모바일에서 칩 컨테이너 간격 조정 */
               .casino-chips-container {
                   margin: 3px 0;
               }
               
               .chips-stack {
                   gap: 6px;
               }
         }
        
        .community-cards {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 5px 0;
            min-height: 87px;
            max-width: 100%;
            flex-wrap: nowrap;
        }
        .card {
            width: 58px;
            height: 87px;
            background: white;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5),
                        0 0 20px rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
            position: relative;
            flex-shrink: 0;
        }
        .card.hidden {
            background: linear-gradient(45deg, #1a1a1a, #2d2d2d);
            color: transparent;
            border: 2px solid #d4af37;
        }
        .card.red {
            color: #e74c3c;
        }
                 .card.black {
             color: #2c3e50;
         }
         
         /* 커뮤니티 카드 색상 강화 */
         .card.red {
             color: #e74c3c;
             text-shadow: 0 1px 2px rgba(0,0,0,0.8);
             font-weight: bold;
         }
         
         .card.black {
             color: #2c3e50;
             text-shadow: 0 1px 2px rgba(255,255,255,0.8);
             font-weight: bold;
         }
         
         /* 카드 문양 크기 및 가시성 개선 */
         .card div:last-child {
             font-size: 1.5rem !important;
             margin-top: 5px;
             text-shadow: 0 2px 4px rgba(0,0,0,0.5);
         }
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .player {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .player.has-cards {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }
        
        .player.no-cards {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
            animation: waitingPulse 2s ease-in-out infinite;
        }
        
        @keyframes waitingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .card-status-icon {
            margin-left: 8px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .card-status-icon.ready {
            background: #27ae60;
            color: white;
        }
        
        .card-status-icon.waiting {
            background: #f39c12;
            color: white;
            animation: iconPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes chipShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 새로운 레이아웃 스타일 */
        .players-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0;
            gap: 20px;  /* 섹션 간 간격 추가 */
            margin-top: 0;
        }

                 .all-players {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 2px;
             max-height: 35vh;
             min-height: 100px;
             overflow-y: auto;
             padding: 0;
             background: transparent !important;
             border: none !important;
             margin: 0;
             position: relative;
             z-index: 999;
             width: 100%;
         }

                 .all-player {
             background: rgba(243, 156, 18, 0.1);
             border-radius: 0;
             padding: 4px 0;
             backdrop-filter: none;
             border: 2px solid #f39c12;
             transition: all 0.3s ease;
             display: flex;
             flex-direction: column;
             gap: 3px;
             min-height: 50px;
         }
         
         /* 자신과 다른 플레이어 구분 스타일 */
         .all-player.current-user {
             border-color: #f39c12;
             background: rgba(243, 156, 18, 0.2);
             box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
         }

         .all-player.other-user {
             border-color: #f39c12;
             background: rgba(243, 156, 18, 0.1);
         }

         /* 패스한 플레이어 스타일 */
         .all-player.passed {
             border-color: #d4af37 !important;  /* 금색 테두리 */
             background: rgba(212, 175, 55, 0.15) !important;
             box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4) !important;
         }

         /* 오프라인 플레이어 스타일 */
         .all-player.offline {
             opacity: 0.6;
             border-color: #e74c3c;
             background: rgba(231, 76, 60, 0.1);
             position: relative;
         }

         .all-player.offline::before {
             content: '🔌 연결 끊김';
             position: absolute;
             top: 5px;
             right: 10px;
             font-size: 12px;
             color: #e74c3c;
             background: rgba(231, 76, 60, 0.2);
             padding: 2px 8px;
             border-radius: 4px;
             font-weight: bold;
         }

                 .all-player.has-cards {
             border-color: #27ae60;
             background: rgba(39, 174, 96, 0.1);
             box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
         }
         
         .all-player.no-cards {
             border-color: #f39c12;
             background: rgba(243, 156, 18, 0.1);
             animation: waitingPulse 2s ease-in-out infinite;
         }
         
         .all-player-info {
             display: flex;
             flex-direction: row;
             align-items: center;
             gap: 8px;
             padding: 0 6px;
         }

         .all-player-bottom-row {
             display: flex;
             flex-direction: row;
             align-items: center;
             justify-content: center;
             gap: 15px;
             padding: 0 6px;
         }

         .all-player-name {
             color: #fff;
             font-size: 13px;
             font-weight: 600;
         }

         .all-player-previous-chips {
             display: flex;
             gap: 3px;
             flex-wrap: wrap;
             align-items: center;
         }

         .all-player-previous-chips .chip-display {
             width: 15px;
             height: 15px;
             border-radius: 50%;
             background: linear-gradient(135deg, #888, #666);
             border: 2px solid rgba(150,150,150,0.8);
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             font-size: 7px;
             font-weight: bold;
             line-height: 1;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
         }

         /* 칩 색상별 스타일 - 이전 라운드 */
         .all-player-previous-chips .chip-display.chip-white {
             background: linear-gradient(135deg, #ffffff, #f0f0f0);
             border-color: rgba(200,200,200,0.8);
         }

         .all-player-previous-chips .chip-display.chip-yellow {
             background: linear-gradient(135deg, #ffd700, #ffb700);
             border-color: rgba(255, 193, 7, 0.8);
         }

         .all-player-previous-chips .chip-display.chip-blue {
             background: linear-gradient(135deg, #4a90e2, #357abd);
             border-color: rgba(74, 144, 226, 0.8);
         }

         .all-player-previous-chips .chip-display.chip-green {
             background: linear-gradient(135deg, #27ae60, #229954);
             border-color: rgba(39, 174, 96, 0.8);
         }

         .all-player-previous-chips .chip-display.chip-red {
             background: linear-gradient(135deg, #e74c3c, #c0392b);
             border-color: rgba(231, 76, 60, 0.8);
         }

         .all-player-previous-chips .chip-display.chip-orange {
             background: linear-gradient(135deg, #ff8c42, #ff6b35);
             border-color: rgba(255, 140, 66, 0.8);
         }

         .all-player-cards {
             display: flex;
             gap: 5px;
             align-items: center;
         }

         .all-player-card {
             width: 30px;
             height: 42px;
             background: linear-gradient(135deg, #2c3e50, #34495e);
             border-radius: 6px;
             border: 1px solid #fff;
             display: flex;
             align-items: center;
             justify-content: center;
             color: #fff;
             font-size: 12px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.3);
         }

         .all-player.current-user .all-player-card {
             background: #fff;
             color: #000;
         }

         .all-player.current-user .all-player-card.red {
             color: #e74c3c;
         }

         .all-player-current-chips {
             display: flex;
             gap: 4px;
             align-items: center;
             flex-wrap: wrap;
         }

         .all-player-current-chips .chip-display {
             width: 30px;
             height: 30px;
             border-radius: 50%;
             background: linear-gradient(135deg, #ffffff, #f0f0f0);
             border: 2px solid rgba(200,200,200,0.8);
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             font-size: 10px;
             font-weight: bold;
             line-height: 1;
             box-shadow: 0 2px 8px rgba(255, 255, 255, 0.6);
         }

         /* 칩 색상별 스타일 - 현재 라운드 */
         .all-player-current-chips .chip-display.chip-white {
             background: linear-gradient(135deg, #ffffff, #f0f0f0);
             border-color: rgba(200,200,200,0.8);
         }

         .all-player-current-chips .chip-display.chip-yellow {
             background: linear-gradient(135deg, #ffd700, #ffb700);
             border-color: rgba(255, 193, 7, 0.8);
         }

         .all-player-current-chips .chip-display.chip-blue {
             background: linear-gradient(135deg, #4a90e2, #357abd);
             border-color: rgba(74, 144, 226, 0.8);
         }

         .all-player-current-chips .chip-display.chip-green {
             background: linear-gradient(135deg, #27ae60, #229954);
             border-color: rgba(39, 174, 96, 0.8);
         }

         .all-player-current-chips .chip-display.chip-red {
             background: linear-gradient(135deg, #e74c3c, #c0392b);
             border-color: rgba(231, 76, 60, 0.8);
         }

         .all-player-current-chips .chip-display.chip-orange {
             background: linear-gradient(135deg, #ff8c42, #ff6b35);
             border-color: rgba(255, 140, 66, 0.8);
         }
         
         /* 카드 색상 스타일 */
         .all-player-card.red {
             color: #e74c3c;
             text-shadow: 0 1px 2px rgba(0,0,0,0.8);
             font-weight: bold;
         }
         
         .all-player-card.black {
             color: #2c3e50;
             text-shadow: 0 1px 2px rgba(255,255,255,0.8);
             font-weight: bold;
         }
         
         /* 요약창 카드 문양 가시성 개선 */
         .all-player-card {
             font-weight: bold;
             text-shadow: 0 1px 2px rgba(0,0,0,0.5);
         }
         
         .all-player-chips {
             display: flex;
             gap: 8px;
         }
         
         .all-player-chip {
             width: 25px;
             height: 25px;
             border-radius: 50%;
             background: linear-gradient(135deg, #ffffff, #f0f0f0);
             border: 2px solid rgba(200,200,200,0.8);
             display: flex;
             align-items: center;
             justify-content: center;
             color: #333;
             font-size: 10px;
             font-weight: bold;
             text-shadow: 0 1px 2px rgba(255,255,255,0.8);
             animation: chipGlow 2s ease-in-out infinite alternate;
             box-shadow: 0 2px 8px rgba(255, 255, 255, 0.6);
         }
         
         /* 카드 뒤에 표시되는 칩들 */
         .all-player-chips-after-cards {
             display: flex;
             gap: 5px;
             margin-left: 10px;
             align-items: center;
         }
         
         .all-player-chips-after-cards .all-player-chip {
             width: 20px;
             height: 20px;
             font-size: 8px;
             background: linear-gradient(135deg, #ffffff, #f0f0f0);
             border: 1px solid rgba(200,200,200,0.8);
             color: #333;
             text-shadow: 0 1px 2px rgba(255,255,255,0.8);
             box-shadow: 0 1px 4px rgba(255, 255, 255, 0.6);
         }

        .my-player-area {
            background: transparent;
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(15px);
            border: none;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.4), inset 0 0 20px rgba(212, 175, 55, 0.1), 0 8px 32px rgba(0,0,0,0.5);
            height: 200px;
            position: relative;
            flex-shrink: 0;
        }

        .my-player-area.has-cards {
            border-color: #d4af37;
            background: transparent;
            box-shadow: 0 0 40px rgba(212, 175, 55, 0.6), inset 0 0 25px rgba(212, 175, 55, 0.15), 0 8px 32px rgba(0,0,0,0.5);
        }

        .my-player-area.no-cards {
            border-color: #c41e3a;
            background: transparent;
            box-shadow: 0 0 30px rgba(196, 30, 58, 0.4), 0 8px 32px rgba(0,0,0,0.5);
            animation: waitingPulse 2s ease-in-out infinite;
        }

        .my-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .my-player-name {
            color: #d4af37;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        .my-player-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 칩 표시 영역 (카드 위에) */
        .my-round-chips-container {
            width: 100%;
            max-width: 780px;
            margin: 0 auto 10px;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 60px;
        }

        /* 카드와 패스 버튼 가로 배치 */
        .my-cards-and-pass {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            max-width: 780px;
            margin: 0 auto 8px;
        }

        .my-cards {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* 카드 크기 80%로 축소 */
        .my-card {
            width: 64px;  /* 80px * 0.8 */
            height: 90px;  /* 112px * 0.8 */
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border-radius: 10px;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: perspective(300px) rotateY(0deg);
            transition: all 0.3s ease;
        }

        .my-card:hover {
            transform: perspective(300px) rotateY(-5deg) translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .my-card-top {
            font-size: 13px;  /* 80% 축소 */
            font-weight: bold;
            line-height: 1;
        }

        .my-card-suit {
            font-size: 26px;  /* 80% 축소 */
            line-height: 1;
        }

        .my-card-bottom {
            font-size: 13px;  /* 80% 축소 */
            font-weight: bold;
            line-height: 1;
            transform: rotate(180deg);
        }

        /* 내 카드 색상 강화 */
        .my-card.red {
            color: #e74c3c;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: bold;
        }

        .my-card.black {
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            font-weight: bold;
        }

        /* 패스 버튼 스타일 */
        .btn-pass {
            width: 80px;
            height: 90px;  /* 카드와 같은 높이 */
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: 2px solid #c0392b;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-pass:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        .btn-pass:active {
            transform: translateY(-2px);
        }

        .btn-pass:disabled {
            background: #95a5a6;
            border-color: #7f8c8d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .my-chips {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

                 .my-chip {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             background: linear-gradient(135deg, #d4af37, #b8941f);
             border: 3px solid #f0d068;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 14px;
             color: #1a1a1a;
             font-weight: bold;
             box-shadow: 0 4px 8px rgba(0,0,0,0.5),
                         0 0 15px rgba(212, 175, 55, 0.4);
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .my-chip:hover {
             transform: translateY(-3px);
             box-shadow: 0 6px 12px rgba(0,0,0,0.6),
                         0 0 25px rgba(212, 175, 55, 0.6);
         }

        .my-chip.collected {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            border: 3px solid #888;
            cursor: default;
            opacity: 0.6;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .game-center {
            text-align: center;
            padding: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
            min-height: 150px;
            margin-bottom: 15px;  /* 하단 간격 추가 */
        }

        /* 중복된 스타일 제거 - 위의 .game-info 스타일과 통합됨 */

        .room-info-compact {
            color: #bdc3c7;
            font-size: 14px;
        }

        .my-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .my-controls-area {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex !important;
            flex-direction: column !important;
            gap: 15px;
            justify-content: flex-start;
            align-items: stretch;
            min-width: 120px;
            width: 120px;
            z-index: 100;
        }

        .game-controls {
            display: flex !important;
            flex-direction: column !important;
            gap: 15px;
            width: 100%;
            position: relative !important;
            z-index: 200;
        }

        .game-controls .btn {
            width: 100% !important;
            margin: 0 !important;
            position: relative !important;
            display: block !important;
            z-index: 201;
            background: linear-gradient(135deg, #d4af37, #b8941f) !important;
            border: 2px solid #f0d068 !important;
            color: #1a1a1a !important;
            font-weight: 600;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3),
                        0 0 20px rgba(212, 175, 55, 0.2) !important;
        }

        .game-controls .btn:hover {
            background: linear-gradient(135deg, #f0d068, #d4af37) !important;
            box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5),
                        0 0 30px rgba(212, 175, 55, 0.4) !important;
        }

        /* 게임 액션 버튼 스타일 */
        #gameActionBtn {
            position: relative !important;
            display: block !important;
            width: 100% !important;
            margin: 0 !important;
            float: none !important;
            clear: both !important;
            z-index: 202 !important;
            background: linear-gradient(135deg, #d4af37, #b8941f) !important;
            border: 2px solid #f0d068 !important;
            color: #1a1a1a !important;
            transition: all 0.3s ease !important;
        }

                 /* 패스 버튼 상태일 때의 스타일 */
         #gameActionBtn.pass-mode {
             background: linear-gradient(135deg, #17a2b8, #138496) !important;
             border-color: #5dccde !important;
             color: #e8e8e8 !important;
         }

         #gameActionBtn.pass-mode:hover:not(:disabled) {
             background: linear-gradient(135deg, #138496, #117a8b) !important;
             border-color: #5dccde !important;
             color: #e8e8e8 !important;
         }


        .player.current {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .player-chips {
            color: #ffd700;
            font-weight: bold;
        }
        .player-cards {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .player-cards .card {
            width: 60px;
            height: 90px;
            font-size: 1rem;
        }
        .player-bet {
            text-align: center;
            color: #ffd700;
            font-weight: bold;
        }
        /* 기존 fixed 스타일을 주석 처리
        .game-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        */
        .controls-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
        }
                 .btn {
             padding: 12px 20px;
             background: linear-gradient(135deg, #d4af37, #b8941f);
             border: 2px solid #f0d068;
             border-radius: 12px;
             font-size: 1rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             min-width: 100px;
             color: #1a1a1a;
             backdrop-filter: blur(10px);
             box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
         }

         .btn:hover {
             background: linear-gradient(135deg, #f0d068, #d4af37);
             transform: translateY(-2px);
             box-shadow: 0 6px 16px rgba(212, 175, 55, 0.5),
                         0 0 30px rgba(212, 175, 55, 0.4);
         }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(135deg, #6c757d, #5a6268);
            border-color: #888;
        }

                 .btn-primary {
             background: linear-gradient(135deg, #d4af37, #b8941f);
             border-color: #f0d068;
             color: #1a1a1a;
         }

         .btn-primary:hover:not(:disabled) {
             background: linear-gradient(135deg, #f0d068, #d4af37);
             border-color: #f0d068;
             color: #1a1a1a;
         }
                 .btn-info {
             background: linear-gradient(135deg, #17a2b8, #138496);
             border-color: #5dccde;
             color: #e8e8e8;
         }

         .btn-info:hover:not(:disabled) {
             background: linear-gradient(135deg, #138496, #117a8b);
             border-color: #5dccde;
             color: #e8e8e8;
         }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
                 .btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }

         .btn:hover:not(:disabled) {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.3);
         }
        .bet-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bet-input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            width: 100px;
            text-align: center;
        }
        .winner {
            color: #ffd700;
            font-weight: bold;
        }
        .room-info {
            text-align: center;
            margin-bottom: 20px;
        }
        .room-info h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .room-info p {
            font-size: 1rem;
        }
        .room-info strong {
            font-weight: bold;
        }
        
        /* 카지노 칩 스타일 */
        .casino-chips-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
            min-height: 120px;
        }
        
        .chips-stack {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            max-width: 400px;
        }
        
                 .casino-chip {
             width: 60px;
             height: 60px;
             border-radius: 50%;
             background: linear-gradient(135deg, #d4af37, #b8941f);
             border: 4px solid #f0d068;
             box-shadow: 0 4px 12px rgba(0,0,0,0.5),
                         0 0 20px rgba(212, 175, 55, 0.4);
             display: flex;
             justify-content: center;
             align-items: center;
             position: relative;
             animation: chipGlow 2s ease-in-out infinite alternate;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .casino-chip:hover {
             transform: scale(1.1);
             box-shadow: 0 6px 20px rgba(212, 175, 55, 0.8),
                         0 0 35px rgba(212, 175, 55, 0.6);
         }
        
        .casino-chip.clicked {
            animation: chipCollect 0.5s ease-out forwards;
        }
        
        .casino-chip.collected {
            animation: none;
            pointer-events: none;
        }
        
        .casino-chip.collected:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* 라운드별 칩 색상 */
        .casino-chip.white {
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            border-color: #ddd;
        }
        
        .casino-chip.yellow {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-color: #e6c200;
        }
        
        .casino-chip.orange {
            background: linear-gradient(135deg, #ff8c00, #ffab40);
            border-color: #e67e00;
        }
        
        .casino-chip.red {
            background: linear-gradient(135deg, #dc3545, #ff6b7a);
            border-color: #c82333;
        }

        /* 쇼다운 UI 스타일 */
        .showdown-container {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            max-width: 900px;
        }

        .showdown-container.active {
            display: flex;
        }

        /* 쇼다운 플레이어 행 - 3칸 레이아웃 */
        .showdown-player-row {
            display: grid;
            grid-template-columns: 90px 1fr 90px;  /* 3칸: 좌/중앙/우 */
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            max-width: 360px;
            margin: 0 auto 10px;
        }

        /* 첫 번째 칸: 아이디 + 칩 */
        .showdown-column-1 {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .showdown-player-name {
            font-weight: bold;
            font-size: 14px;
            color: white;
            text-align: center;
            word-break: break-word;
            max-width: 90px;
        }

        .showdown-red-chip {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc3545, #ff6b7a);
            border: 3px solid #c82333;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
        }

        /* 두 번째 칸: 카드 2장 */
        .showdown-column-2 {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .showdown-pocket-cards {
            display: flex;
            flex-direction: row;  /* 명시적으로 가로 배치 */
            gap: 5px;
            flex-wrap: nowrap;
        }

        .showdown-pocket-cards .card {
            width: 50px;
            height: 70px;
            font-size: 14px;
            padding: 4px;
            flex-shrink: 0;  /* 카드 크기 유지 */
        }

        /* 세 번째 칸: 포커핸드 + 성공/실패 */
        .showdown-column-3 {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .showdown-hand-name {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            word-break: keep-all;
            max-width: 90px;
        }

        .showdown-result-badge {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }

        .showdown-result-badge.success {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
            animation: successPulse 1.5s ease-in-out;
        }

        .showdown-result-badge.fail {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
            animation: failFlash 1s ease-in-out;
        }

        /* 성공 애니메이션 - 황금빛 펄스 */
        @keyframes successPulse {
            0% {
                transform: scale(0.5);
                box-shadow: 0 0 0 rgba(212, 175, 55, 0);
                background: linear-gradient(135deg, #d4af37, #f4d03f);
            }
            25% {
                transform: scale(1.3);
                box-shadow: 0 0 40px rgba(212, 175, 55, 1), 0 0 80px rgba(212, 175, 55, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 30px rgba(212, 175, 55, 0.8);
            }
            75% {
                transform: scale(1.2);
                box-shadow: 0 0 35px rgba(212, 175, 55, 0.9);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
                background: linear-gradient(135deg, #28a745, #20c997);
            }
        }

        /* 실패 애니메이션 - 빨간 점멸 */
        @keyframes failFlash {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
                opacity: 1;
            }
            10%, 30%, 50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px rgba(220, 53, 69, 1);
                opacity: 0.8;
            }
            20%, 40%, 60% {
                transform: scale(0.95);
                box-shadow: 0 0 5px rgba(220, 53, 69, 0.3);
                opacity: 0.6;
            }
        }

        /* 성공한 플레이어 행 전체 효과 */
        .showdown-player-row.success-effect {
            animation: rowSuccessGlow 2s ease-in-out;
        }

        @keyframes rowSuccessGlow {
            0%, 100% {
                background: rgba(20, 25, 30, 0.8);
                border-color: rgba(212, 175, 55, 0.3);
            }
            50% {
                background: rgba(212, 175, 55, 0.15);
                border-color: rgba(212, 175, 55, 0.8);
                box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
            }
        }

        /* 실패한 플레이어 행 전체 효과 */
        .showdown-player-row.fail-effect {
            animation: rowFailDarken 1.5s ease-in-out;
        }

        @keyframes rowFailDarken {
            0%, 100% {
                background: rgba(20, 25, 30, 0.8);
                border-color: rgba(212, 175, 55, 0.3);
            }
            50% {
                background: rgba(80, 20, 20, 0.3);
                border-color: rgba(220, 53, 69, 0.5);
            }
        }

        /* 카드 회색 효과 (실패 시) */
        .showdown-pocket-cards.failed .card {
            filter: grayscale(100%) brightness(0.6);
            animation: cardFadeOut 1s ease-in-out;
        }

        @keyframes cardFadeOut {
            0% {
                filter: grayscale(0%) brightness(1);
                transform: rotateY(0deg);
            }
            50% {
                filter: grayscale(50%) brightness(0.8);
                transform: rotateY(10deg);
            }
            100% {
                filter: grayscale(100%) brightness(0.6);
                transform: rotateY(0deg);
            }
        }

        /* 코인 터지는 효과 (성공 시) */
        .coin-burst {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #f4d03f, #d4af37);
            border-radius: 50%;
            animation: coinBurst 1s ease-out forwards;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
        }

        @keyframes coinBurst {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* 모바일 최적화 (360px) */
        @media (max-width: 380px) {
            .showdown-player-row {
                grid-template-columns: 80px 1fr 80px;
                gap: 5px;
                padding: 8px;
            }

            .showdown-player-name {
                font-size: 12px;
            }

            .showdown-red-chip {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }

            .showdown-pocket-cards .card {
                width: 45px;
                height: 63px;
                font-size: 12px;
            }

            .showdown-hand-name {
                font-size: 11px;
            }

            .showdown-result-badge {
                width: 30px;
                height: 30px;
                font-size: 18px;
            }
        }

        /* 금고/경보 카운터 스타일 */
         .heist-score-container {
             display: flex;
             justify-content: center;
             gap: 20px;
             padding: 2px 15px;
             margin: 0 auto 0 auto;
             max-width: 600px;
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.3s ease, visibility 0.3s ease;
         }

        .heist-score-container.visible {
            opacity: 1;
            visibility: visible;
        }

         .heist-score-badge {
             padding: 8px 18px;
             border-radius: 10px;
             font-weight: bold;
             font-size: 1rem;
             box-shadow: 0 4px 15px rgba(0,0,0,0.3);
             display: flex;
             align-items: center;
             gap: 8px;
             border: 3px solid rgba(255,255,255,0.3);
         }

        .heist-score-badge.success {
            background: linear-gradient(135deg, #d4af37, #f4d03f);
            color: #000;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .heist-score-badge.fail {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        /* 확인 섹션 스타일 */
        .showdown-confirm-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .confirm-button {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .confirm-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .confirm-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .confirm-progress {
            font-size: 1rem;
            color: #ffd700;
            font-weight: 600;
        }

        /* 수집한 칩 표시 스타일 */
        .player-cards-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .collected-chips-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        
                 .collected-chip-icon {
             width: 24px;
             height: 24px;
             border-radius: 50%;
             background: linear-gradient(135deg, #95a5a6, #7f8c8d);
             border: 2px solid rgba(255,255,255,0.3);
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: default;
             position: relative;
             animation: chipGlow 2s ease-in-out infinite alternate;
         }

         .collected-chip-icon:hover {
             transform: scale(1.1);
             box-shadow: 0 2px 8px rgba(255,215,0,0.4);
         }

         .chip-icon-inner {
             display: flex;
             align-items: center;
             justify-content: center;
             width: 100%;
             height: 100%;
         }

         .chip-number {
             color: #fff;
             font-size: 10px;
             font-weight: bold;
             text-shadow: 0 1px 2px rgba(0,0,0,0.5);
         }
        
        .casino-chip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
        }
        
        .casino-chip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        
        .chip-stars {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            gap: 2px;
            z-index: 20;
        }
        
        .chip-star {
            color: #fff;
            font-size: 12px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            animation: starTwinkle 1.5s ease-in-out infinite;
            line-height: 1;
            font-weight: bold;
            z-index: 10;
            position: relative;
        }
        
        .chip-star:nth-child(odd) {
            animation-delay: 0.5s;
        }
        
        /* 다른 플레이어의 수집된 칩 표시 스타일 */
        .other-player-chips {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }
        
                 .other-player-chip {
             width: 20px;
             height: 20px;
             border-radius: 50%;
             background: linear-gradient(135deg, #95a5a6, #7f8c8d);
             border: 2px solid rgba(255,255,255,0.3);
             display: flex;
             align-items: center;
             justify-content: center;
             color: #fff;
             font-size: 12px;
             font-weight: bold;
             text-shadow: 0 1px 2px rgba(0,0,0,0.5);
             animation: chipGlow 2s ease-in-out infinite alternate;
         }

         .other-player-chip:hover {
             transform: scale(1.1);
             box-shadow: 0 2px 8px rgba(255,215,0,0.4);
         }
        
        @keyframes chipGlow {
            0% {
                box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
            }
            100% {
                box-shadow: 0 4px 20px rgba(255, 255, 255, 0.7);
            }
        }
        
        @keyframes starTwinkle {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        @keyframes chipCollect {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3) translateY(-20px);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) translateY(-50px);
                opacity: 0;
            }
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .current-turn {
            border: 2px solid #ffd700 !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5) !important;
        }
        /* 오프라인 플레이어 스타일 */
        .all-player.offline {
            opacity: 0.6;
            border-color: #e74c3c !important;
            background: rgba(231, 76, 60, 0.1) !important;
        }
        
        .all-player.offline .all-player-name {
            color: #ff4444 !important;
        }
    </style>
</head>
<body>
    <!-- 게임 헤더 -->
    <div class="game-info-header">
        <div class="room-name">
            <span id="roomName"></span>
        </div>
        <div class="game-phase-center" id="gamePhase">-</div>
        <button id="backToLobbyBtn" class="btn btn-secondary">로비로</button>
    </div>

    <!-- 금고/경보 카운터 (헤더 바로 아래) -->
    <div class="heist-score-container visible" id="heistScoreContainer">
        <div class="heist-score-badge success">
            <span>💰 금고:</span><span id="vaultCount">0</span>
        </div>
        <div class="heist-score-badge fail">
            <span>🚨 경보:</span><span id="alarmCount">0</span>
        </div>
    </div>

    <div class="players-container">

        <!-- 상단: 게임 정보 및 진행 단계 -->
        <div class="game-info">
            <!-- 모든 플레이어들 정보 -->
            <div class="all-players" id="allPlayersList">
                <!-- 모든 플레이어들이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>

        <!-- 중앙: 커뮤니티 카드 및 게임 요소들 -->
        <div class="game-center">
            <div class="community-cards" id="communityCards"></div>

            <!-- 쇼다운 UI -->
            <div class="showdown-container" id="showdownContainer">
                <div id="showdownPlayersContainer">
                    <!-- 쇼다운 플레이어 행들이 여기에 동적으로 추가됩니다 -->
                </div>
                <div class="showdown-confirm-section" id="showdownConfirmSection">
                    <button class="confirm-button" id="confirmShowdownBtn">확인</button>
                    <div class="confirm-progress" id="confirmProgress"></div>
                </div>
            </div>

            <!-- 카지노 칩 영역 -->
            <div class="casino-chips-container" id="casinoChipsContainer">
                <div class="chips-stack">
                    <!-- 칩들이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
            
        </div>
        
                <!-- 하단: 내 플레이어 영역 -->
        <div class="my-player-area" id="myPlayerArea">
            <div class="my-content-area">
                <!-- 라운드별 칩 표시 (가로 배치) -->
                <div class="my-round-chips-container" id="myChips">
                    <!-- 현재 라운드 칩들이 여기에 표시됩니다 -->
                </div>

                <!-- 카드와 패스 버튼 (가로 배치) -->
                <div class="my-cards-and-pass">
                    <div class="my-cards" id="myCards">
                        <!-- 내 카드들이 여기에 표시됩니다 -->
                    </div>
                    <button class="btn btn-pass" id="passBtn" onclick="pass()" style="display: none;">패스</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 탈주 확인 모달 -->
    <div id="leaveModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; color:#222; padding:2rem; border-radius:16px; min-width:300px; text-align:center;">
            <p style="margin-bottom:2rem; font-size:1.2rem;">정말 탈주하시겠습니까?</p>
            <button id="confirmLeaveBtn" class="btn btn-danger" style="margin-right:1rem;">네, 탈주</button>
            <button id="cancelLeaveBtn" class="btn btn-success">취소</button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    let socket;
    let currentPlayer = null;
    let gameState = {
        players: [],
        currentPlayer: null,
        phase: 'playing',
        roomId: null,
        pot: 0,
        isMyTurn: false,
        communityCards: [],
        collectedChips: []
    };
    let isMyTurn = true; // 실시간 게임으로 변경 - 항상 액션 가능
    let isAdmin = false;
    
    // URL 파라미터를 전역에서 한 번만 선언
    const urlParams = new URLSearchParams(window.location.search);
    
    // 일반 사용자용으로 수정된 관리자 권한 확인
    async function checkAdminStatus() {
        return false; // 일반 사용자는 관리자가 아님
    }
    
    function connectSocket() {
        console.log('\n=== [SOCKET CONNECTION START] ===');
        socket = io({
            reconnection: true,
            reconnectionDelay: 500,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: Infinity,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });
        
        socket.on('connect', async () => {
            console.log('[SOCKET] Successfully connected with ID:', socket.id);
            
            // 사용자 정보 가져오기 및 등록
            try {
                const response = await fetch('/api/user');
                
                if (response.ok) {
                    const userData = await response.json();
                    
                    if (userData && userData.username) {
                        console.log('[USER] 사용자 등록 시도:', userData.username);
                        
                        if (socket.connected) {
                            socket.emit('registerUser', userData.username);
                        }
                    }
                }
            } catch (error) {
                console.error('사용자 정보 가져오기 실패:', error);
            }
            
            // URL에서 roomId 가져와서 방 참여
            const roomId = urlParams.get('roomId');
            console.log('[ROOM] Attempting to join room:', roomId);

            if (roomId) {
                console.log('[ROOM] Sending joinRoom event for:', roomId);
                socket.emit('joinRoom', { roomId: roomId });

                // 새로고침 후 게임 상태 복구를 위해 현재 상태 요청
                setTimeout(() => {
                    console.log('[ROOM] Requesting current game state after rejoin');
                    socket.emit('requestGameState', { roomId: roomId });
                }, 500);
            } else {
                console.log('[ROOM] No roomId in URL, staying in lobby');
            }
        });
        
        // 소켓 연결 실패 시 재연결
        socket.on('connect_error', (error) => {
            console.error('소켓 연결 실패:', error);
            setTimeout(() => {
                console.log('소켓 재연결 시도...');
                socket.connect();
            }, 2000);
        });
        
        socket.on('gameState', (state) => {
            updateGameState(state);
        });
        
                 // 칩 수집 이벤트 처리
         socket.on('chipCollected', (data) => {
             console.log('칩 수집 이벤트:', data);
             
             // 게임 상태 업데이트
             if (gameState) {
                 // 서버에서 받은 데이터로 collectedChips 업데이트
                 if (data.remainingChips && Array.isArray(data.remainingChips)) {
                     gameState.collectedChips = data.remainingChips;
                 } else if (data.chipIndex !== undefined) {
                     // remainingChips가 없으면 현재 칩 인덱스 추가
                     if (!gameState.collectedChips) {
                         gameState.collectedChips = [];
                     }
                     if (!gameState.collectedChips.includes(data.chipIndex)) {
                         gameState.collectedChips.push(data.chipIndex);
                     }
                 }
                 
                 console.log('칩 수집 후 gameState.collectedChips 업데이트:', gameState.collectedChips);
             }
             
             // 카지노 칩 UI 업데이트
             const collectedChips = gameState?.collectedChips || [];
             // updateCasinoChips(gameState?.players?.length || 2, collectedChips); // 비활성화: updateCenterChips 사용
             
             // 요약창 업데이트를 위해 플레이어 목록 새로고침
             if (gameState && gameState.players) {
                 console.log('칩 수집 후 플레이어 목록 업데이트 시작');
                 updatePlayers(gameState.players);
                 console.log('칩 수집 후 플레이어 목록 업데이트 완료');
             }
             
             // 내 플레이어 정보도 업데이트 (칩 수집 상태 반영)
             const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                    sessionStorage.getItem('username') || window.currentUser;
             const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
             if (myPlayer) {
                 console.log('칩 수집 후 내 플레이어 정보 업데이트 시작');
                 updateMyPlayer(myPlayer);
                 console.log('칩 수집 후 내 플레이어 정보 업데이트 완료');
             }
             
             // 컨트롤 업데이트
             updateControls();
             
             // 메시지 표시
             showMessage(`${data.collectedBy}님이 칩 ${data.chipIndex + 1}을 수집했습니다!`);
             
             console.log('칩 수집 이벤트 처리 완료');
         });
        
        // 플랍 이벤트 처리
        socket.on('flopDealt', (data) => {
            console.log('플랍 이벤트:', data);
            
            if (data.gameState) {
                updateGameState(data.gameState);
            }
            
            showMessage(data.message || '플랍이 공개되었습니다!');
        });
        
        socket.on('gameMessage', (message) => {
            showMessage(message);
        });
        
        socket.on('gameOver', (result) => {
            showGameOver(result);
        });
        
        socket.on('cardsDealt', (data) => {
            console.log('개별 카드 분배 완료:', data);
            updateGameState(data.gameState);
            showMessage(data.message || '카드를 받았습니다!');
            
            // 카드를 받았으므로 버튼을 패스 모드로 전환
            switchToPassMode();
        });
        
        // 다른 플레이어가 카드를 받았을 때
        socket.on('playerReceivedCards', (data) => {
            console.log('다른 플레이어 카드 받기:', data);
            updateGameState(data.gameState);
            showMessage(data.message || `${data.playerName}님이 카드를 받았습니다!`);
            
            // 본인이 아직 카드를 받지 않은 경우에만 진행 상황 표시
            const gameActionBtn = document.getElementById('gameActionBtn');
            if (gameActionBtn && data.gameState && gameActionMode === 'deal') {
                const progress = `${data.gameState.playersWithCards}/${data.gameState.totalPlayers}`;
                if (data.gameState.playersWithCards < data.gameState.totalPlayers) {
                    gameActionBtn.textContent = `카드 받기 (${progress})`;
                }
            }
            
            console.log('다른 플레이어 카드 받기 처리 완료 - 본인 버튼 상태:', {
                mode: gameActionMode,
                textContent: gameActionBtn?.textContent
            });
        });
        
        // 모든 플레이어가 카드를 받은 후 커뮤니티 카드 공개
        socket.on('communityCardsRevealed', (data) => {
            console.log('커뮤니티 카드 공개 이벤트 수신:', data);
            console.log('수신된 게임 상태의 커뮤니티 카드:', data.gameState?.communityCards);
            console.log('수신된 방 상태의 커뮤니티 카드:', data.room?.communityCards);
            
            updateGameState(data.gameState);
            showMessage(data.message || '커뮤니티 카드가 공개되었습니다!');
            
            // 현재 라운드 종료 - 카드 받기 버튼 숨김
            // 카드 받기 버튼 제거됨
            // const dealCardsBtn = document.getElementById('dealCardsBtn');
            // 카드 받기 버튼 제거됨
            if (false && dealCardsBtn) {
                dealCardsBtn.style.display = 'none'; // 커뮤니티 카드가 공개되면 숨김
            }
            
            // 다음 라운드를 위해 카드 받기 상태 초기화 (하지만 버튼은 새 라운드 시작 시까지 숨김)
            cardsDealRequested = false;
        });
        
        socket.on('disconnect', (reason) => {
            console.log('게임 소켓 연결이 끊어졌습니다. 이유:', reason);
        });
        
        // 자동 사용자 게임 시작 이벤트
        socket.on('autoStartUserGame', (data) => {
            console.log('자동 사용자 게임 시작:', data);
            showMessage(data.message || '새 게임을 시작합니다...');
            
            // 사용자 게임 시작 호출
            setTimeout(() => {
                socket.emit('startUserGame', { roomId: data.roomId });
            }, 500);
        });
        
        // 방 재참여 성공 이벤트
        socket.on('roomRejoinSuccess', (data) => {
            console.log('방 재참여 성공:', data);
            if (data.roomId) {
                console.log('재참여한 roomId로 게임 상태 설정:', data.roomId);
                // gameState에 roomId 설정
                if (gameState) {
                    gameState.roomId = data.roomId;
                } else {
                    gameState = { roomId: data.roomId };
                }
                
                // 방에 다른 플레이어가 있으면 멀티플레이어 모드
                const playerCount = data.room?.players?.length || 1;
                showMessage(`방에 재참여했습니다. (${playerCount}명의 플레이어)`);
                
                // 게임 상태 업데이트
                if (data.room) {
                    updateGameState({
                        roomId: data.room.id,
                        players: data.room.players,
                        phase: data.room.phase || 'playing',
                        communityCards: data.room.communityCards || [],
                        currentRound: data.room.currentRound || 1,
                        maxRounds: data.room.maxRounds || 5,
                        pot: data.room.pot || 0
                    });
                }
                
                // 사용자 게임 시작 이벤트 발생
                socket.emit('startUserGame', { roomId: data.roomId });
            }
        });
        
        // 게임 방 찾기/생성 완료 이벤트
        socket.on('gameRoomFound', (data) => {
            console.log('게임 방 찾기/생성 완료:', data);
            if (data.roomId) {
                console.log('찾거나 생성된 roomId로 게임 상태 설정:', data.roomId);
                // gameState에 roomId 설정
                if (gameState) {
                    gameState.roomId = data.roomId;
                } else {
                    gameState = { roomId: data.roomId };
                }
                
                // 방에 다른 플레이어가 있으면 멀티플레이어 모드
                const playerCount = data.room?.players?.length || 1;
                if (playerCount > 1) {
                    showMessage(`${playerCount}명의 플레이어와 함께 게임을 시작합니다!`);
                } else {
                    showMessage('게임 방이 준비되었습니다. 카드 받기 버튼을 눌러주세요.');
                }
                
                // 사용자 게임 시작 이벤트 발생
                socket.emit('startUserGame', { roomId: data.roomId });
            }
        });
        
        // 플레이어 참여 이벤트
        socket.on('playerJoined', (data) => {
            console.log('새 플레이어 참여:', data);
            
            // gameState가 있으면 바로 업데이트
            if (data.gameState) {
                updateGameState(data.gameState);
                showMessage(`${data.username}님이 게임에 참여했습니다!`);
            } else if (data.room) {
                // 기존 방식 호환성 유지
                updateGameState({
                    roomId: data.room.id,
                    players: data.room.players,
                    phase: data.room.phase || 'playing',
                    communityCards: data.room.communityCards || [],
                    currentRound: data.room.currentRound || 1,
                    maxRounds: data.room.maxRounds || 5,
                    pot: data.room.pot || 0
                });
                showMessage(`${data.player?.username || data.username}님이 게임에 참여했습니다!`);
            } else {
                showMessage(`${data.username}님이 게임에 참여했습니다!`);
            }
        });
        
        // 관리자 방 생성 완료 이벤트 (관리자 전용)
        socket.on('adminRoomCreated', (data) => {
            console.log('관리자 방 생성 완료:', data);
            if (data.roomId) {
                console.log('생성된 roomId로 게임 상태 설정:', data.roomId);
                // gameState에 roomId 설정
                if (gameState) {
                    gameState.roomId = data.roomId;
                }
                showMessage('관리자 방이 생성되었습니다. 카드 받기 버튼을 눌러주세요.');
            }
        });
        
        // 게임 시작 이벤트
        socket.on('gameStarted', (data) => {
            console.log('게임 시작:', data);
            
            // roomId 설정 (우선순위: data.roomId > data.gameState.roomId)
            const roomId = data.roomId || data.gameState?.roomId;
            if (roomId) {
                console.log('게임 시작 시 roomId 설정:', roomId);
                if (gameState) {
                    gameState.roomId = roomId;
                } else {
                    gameState = { roomId: roomId };
                }
            } else {
                console.error('게임 시작 이벤트에 roomId가 없습니다!', data);
            }
            
            // collectedChips 초기화
            if (data.gameState) {
                data.gameState.collectedChips = [];
            }
            
            // 카드 받기 상태 초기화
            cardsDealRequested = false;
            
            // 버튼을 카드 받기 모드로 리셋
            resetToDealMode();
            
            updateGameState(data.gameState);
            
            // 방 정보 업데이트
            if (data.room) {
                updateRoomInfo(data.room);
            }
            
            // 플레이어 수는 실제 게임 상태에서 업데이트됨
            
            // 게임 상태를 playing으로 설정
            if (data.gameState) {
                data.gameState.phase = 'playing';
            }
            
            showMessage('게임이 시작되었습니다! 모든 플레이어가 동시에 카드를 받을 수 있습니다.');
            
            // 게임 시작 후 즉시 모든 사용자의 카드 받기 버튼 활성화
            setTimeout(() => {
                updateControls();
                // 카드 받기 버튼 상태 복원 (모든 사용자 동시 활성화)
                // 카드 받기 버튼 제거됨
            // const dealCardsBtn = document.getElementById('dealCardsBtn');
                // 카드 받기 버튼 제거됨
            if (false && dealCardsBtn) {
                    dealCardsBtn.disabled = false;
                    dealCardsBtn.textContent = '카드 받기';
                    dealCardsBtn.style.display = 'inline-block';
                }
            }, 100);
        });
        
        // 사용자 등록 성공 이벤트 (일반 사용자용으로 수정)
        socket.on('registerUserSuccess', (data) => {
            console.log('사용자 등록 성공', data);
            
            // 사용자명을 여러 위치에 안전하게 저장
            if (data && data.username) {
                localStorage.setItem('username', data.username);
                sessionStorage.setItem('username', data.username);
                window.currentUser = data.username;
                console.log('사용자명 저장 완료:', data.username);
            } else {
                // URL에서 사용자명 추출 (fallback)
                // urlParams는 전역에서 선언됨
                const urlUsername = urlParams.get('username');
                if (urlUsername) {
                    localStorage.setItem('username', urlUsername);
                    sessionStorage.setItem('username', urlUsername);
                    window.currentUser = urlUsername;
                    console.log('URL에서 사용자명 추출:', urlUsername);
                }
            }
            
            // URL에서 roomId 확인
            // urlParams는 전역에서 선언됨
            const urlRoomId = urlParams.get('roomId');
            
            if (urlRoomId) {
                console.log('URL에서 roomId 발견, 기존 방으로 복귀 시도:', urlRoomId);
                console.log('현재 사용자명:', data.username || window.currentUser);
                
                // gameState에 roomId 설정
                if (gameState) {
                    gameState.roomId = urlRoomId;
                } else {
                    gameState = { roomId: urlRoomId };
                }
                
                // 약간의 지연 후 재입장 요청 (서버에서 등록 처리 완료 대기)
                setTimeout(() => {
                    console.log('rejoinRoom 이벤트 전송 - roomId:', urlRoomId);
                    socket.emit('rejoinRoom', { roomId: urlRoomId });
                }, 500);
            } else {
                console.log('URL에 roomId 없음, 새 게임 찾기/생성');
                // 새 게임 찾기/생성 (관리자 게임이 아님)
                setTimeout(() => {
                    socket.emit('findOrCreateGameRoom', {});
                }, 1000);
            }
        });
        
        // 새로운 이벤트 핸들러들 추가
        socket.on('rejoinRoomSuccess', (roomState) => {
            console.log('방 재입장 성공:', roomState);
            updateGameState(roomState);
            showMessage('게임에 다시 연결되었습니다.');
        });

        socket.on('gameStateUpdate', (roomState) => {
            console.log('\n=== [GAME STATE UPDATE] ===');
            console.log('Received roomState:', roomState);
            console.log('CenterChips in update:', roomState?.centerChips?.length);
            
            updateGameState(roomState);
            console.log('=== [GAME STATE UPDATE END] ===\n');
        });
        
        // 중앙 칩 전용 업데이트 이벤트
        socket.on('centerChipsUpdate', (data) => {
            console.log('\n=== [CENTER CHIPS UPDATE] ===');
            console.log('Received centerChips:', data.centerChips?.length);
            
            if (data.centerChips !== undefined) {
                gameState.centerChips = data.centerChips;
                updateCenterChips(data.centerChips);
            }
            
            console.log('=== [CENTER CHIPS UPDATE END] ===\n');
        });

        socket.on('redirectToLobby', (data) => {
            console.log('로비로 리다이렉트:', data);
            console.error('게임 페이지 오류 - 로비로 리다이렉트됨:', data);
            if (data.message) {
                console.error('오류 메시지:', data.message);
                alert(data.message);
            }
            window.location.href = '/';
        });

        // 소켓 이벤트 테스트
        socket.on('connect', () => {
            console.log('[SOCKET] Connected with ID:', socket.id);
        });
        
        socket.on('disconnect', () => {
            console.log('[SOCKET] Disconnected');
        });
        
        // 모든 이벤트 캐치 (Socket 참조 오류 수정)
        const originalOnevent = socket.onevent;
        socket.onevent = function(packet) {
            console.log('[SOCKET EVENT]', packet.data[0], packet.data[1]);
            if (originalOnevent) {
                originalOnevent.call(this, packet);
            }
        };

        // 칩 가져가기 이벤트 - 완전 재작성
        socket.on('chipTaken', (data) => {
            console.log('\n=== [CLIENT CHIP TAKEN RECEIVED] ===');
            console.log('Socket ID:', socket.id);
            console.log('Received data:', data);
            console.log('Current gameState centerChips:', gameState.centerChips?.length);
            
            showMessage(data.message);
            
            // 서버에서 받은 최신 게임 상태로 완전 교체
            if (data.gameState) {
                console.log('[CLIENT] Updating with server gameState');
                console.log('Server centerChips:', data.gameState.centerChips?.length);
                console.log('Server players:', data.gameState.players?.length);
                
                // 전체 게임 상태 업데이트
                updateGameState(data.gameState);
            }
            
            console.log('=== [CLIENT CHIP TAKEN END] ===\n');
        });
        
        socket.on('chipsExchanged', (data) => {
            console.log('칩 교환 이벤트:', data);
            showMessage(data.message);
            
            // 중앙 칩 즉시 업데이트
            if (data.centerChips) {
                updateCenterChips(data.centerChips);
            }
            
            if (data.gameState) {
                updateGameState(data.gameState);
            }
        });
        
        // 패스 상태 해제 알림 처리
        socket.on('passStatusReset', (data) => {
            console.log('패스 상태 해제:', data);
            showMessage(data.message || '칩 정보가 변경되어 패스가 해제되었습니다.');
            
            // 패스 버튼 다시 활성화
            const passBtn = document.getElementById('passBtn');
            if (passBtn) {
                passBtn.disabled = false;
            }
            
            // 패스 버튼 업데이트
            updateControls();
        });

        // The Gang 게임 이벤트 핸들러들
        socket.on('round1Started', (data) => {
            console.log('1라운드 시작:', data);
            updateGameState(data.gameState);
            showMessage(data.message);
            
            // 라운드 정보 업데이트
            if (data.roundConfig) {
                updateGamePhase(`${data.roundConfig.name}: ${data.roundConfig.description}`);
            } else {
                updateGamePhase('1라운드 진행 중');
            }
            
            // 커뮤니티 카드 업데이트 (1라운드에서는 빈 배열)
            if (data.communityCards !== undefined) {
                updateCommunityCards(data.communityCards);
            }
            
            // 라운드 정보 업데이트
            if (data.round && data.maxRounds) {
                updateRoundInfo(data.round, data.maxRounds);
            }
        });

        // 2라운드 시작 이벤트
        socket.on('round2Started', (data) => {
            console.log('2라운드 시작:', data);
            updateGameState(data.gameState);
            showMessage(data.message);
            
            // 커뮤니티 카드 업데이트
            if (data.communityCards !== undefined) {
                updateCommunityCards(data.communityCards);
            }
            
            // 라운드 정보 업데이트
            updateGamePhase('2라운드(Flop) 진행 중');
        });

        // 3라운드 시작 이벤트
        socket.on('round3Started', (data) => {
            console.log('3라운드 시작:', data);
            updateGameState(data.gameState);
            showMessage(data.message);
            
            // 커뮤니티 카드 업데이트
            if (data.communityCards !== undefined) {
                updateCommunityCards(data.communityCards);
            }
            
            // 라운드 정보 업데이트
            updateGamePhase('3라운드(Turn) 진행 중');
        });

        // 4라운드 시작 이벤트
        socket.on('round4Started', (data) => {
            console.log('4라운드 시작:', data);
            updateGameState(data.gameState);
            showMessage(data.message);
            
            // 커뮤니티 카드 업데이트
            if (data.communityCards !== undefined) {
                updateCommunityCards(data.communityCards);
            }
            
            // 라운드 정보 업데이트
            updateGamePhase('4라운드(River) 진행 중');
        });

        socket.on('yourTurn', (data) => {
            console.log('턴 알림 (실시간 게임으로 인해 무시):', data);
            // 실시간 게임으로 변경 - 턴 개념 제거
            // isMyTurn = true;
            // showMessage(data.message);
            // updateActionButtons(data.availableActions);
            // updatePlayerTurnIndicators(getCurrentUsername());
        });

        socket.on('playerTurn', (data) => {
            console.log('플레이어 턴 알림 (실시간 게임으로 인해 무시):', data);
            // 실시간 게임으로 변경 - 턴 개념 제거
            // isMyTurn = false;
            // showMessage(data.message);
            // updateActionButtons([]);
            // updatePlayerTurnIndicators(data.currentPlayer);
        });

        // 중복 제거 - 이미 위에 정의되어 있음

        socket.on('playerPassed', (data) => {
            console.log('플레이어 패스:', data);
            showMessage(data.message);
            // 게임 상태가 업데이트되면 UI도 자동으로 업데이트될 것임
        });

        socket.on('roundEnded', (data) => {
            console.log('라운드 종료:', data);
            showMessage(`${data.round}라운드 종료: ${data.message}`);
            
            // 모든 플레이어의 패스 상태 초기화
            if (gameState && gameState.players) {
                gameState.players.forEach(player => {
                    player.hasPassed = false;
                });
                updatePlayers(gameState.players);
            }
        });

        socket.on('nextRoundStarted', (data) => {
            console.log('다음 라운드 시작:', data);
            showMessage(data.message);
            
            // 게임 상태 업데이트
            updateGameState(data.gameState);
            updateRoundInfo(data.round, data.maxRounds);
            
            // 커뮤니티 카드 업데이트
            if (data.communityCards) {
                updateCommunityCards(data.communityCards);
            }
            
            // 라운드 정보 표시
            if (data.roundConfig) {
                const gamePhaseEl = document.getElementById('gamePhase');
                if (gamePhaseEl) {
                    gamePhaseEl.textContent = data.roundConfig.name;
                }
            }
        });

        socket.on('showdownResult', (data) => {
            console.log('쇼다운 결과:', data);
            renderShowdown(data);
        });

        socket.on('showdownConfirmUpdate', (data) => {
            console.log('쇼다운 확인 업데이트:', data);
            const progressEl = document.getElementById('confirmProgress');
            if (progressEl) {
                progressEl.textContent = `대기중: ${data.confirmed}/${data.total}명 확인`;
            }
        });

        socket.on('nextHeistPreparing', (data) => {
            console.log('다음 하이스트 준비:', data);
            showMessage(data.message);

            // 게임 상태 초기화
            if (gameState) {
                gameState.collectedChips = [];
                gameState.centerChips = [];
                gameState.communityCards = [];
            }

            // 클라이언트 카드 영역 초기화
            const myCardsArea = document.getElementById('myCardsArea');
            if (myCardsArea) {
                myCardsArea.innerHTML = '<div style="color: rgba(255,255,255,0.5);">새로운 카드를 기다리는 중...</div>';
            }

            // 커뮤니티 카드 영역 초기화
            const communityCardsArea = document.getElementById('communityCards');
            if (communityCardsArea) {
                communityCardsArea.innerHTML = '';
            }
        });

        socket.on('gameEnded', (data) => {
            console.log('게임 종료:', data);

            // 팀 결과 표시
            let resultMessage = '\n━━━━━━━━━━━━━━━━━━━━━━━━━━\n';

            if (data.victory) {
                resultMessage += '🎉 축하합니다! 팀 승리!\n';
                resultMessage += `✅ 금고 ${data.totalVaults}개 획득\n`;
                showMessage('🎉 팀 승리!');
            } else {
                resultMessage += '💥 아쉽습니다! 팀 패배...\n';
                resultMessage += `❌ 경보 ${data.totalAlarms}회 발생\n`;
                showMessage('💥 팀 패배...');
            }

            resultMessage += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';

            // 하이스트별 결과 요약
            resultMessage += '📊 하이스트 결과:\n';
            if (data.heistHistory && data.heistHistory.length > 0) {
                data.heistHistory.forEach((heist) => {
                    const icon = heist.success ? '✅' : '❌';
                    resultMessage += `${icon} 하이스트 ${heist.heistNumber}: ${heist.success ? '성공' : '실패'}\n`;

                    // 각 하이스트의 칩 순서 표시
                    if (heist.chipOrder && heist.chipOrder.length > 0) {
                        const chipOrderStr = heist.chipOrder
                            .map(p => `${p.username}(${p.chipStars}별)`)
                            .join(' → ');
                        resultMessage += `   칩: ${chipOrderStr}\n`;
                    }
                });
            } else {
                resultMessage += '   (기록 없음)\n';
            }

            resultMessage += '\n━━━━━━━━━━━━━━━━━━━━━━━━━━\n';

            console.log(resultMessage);
            alert(resultMessage);

            // 로비로 돌아가기 버튼 표시
            const backBtn = document.getElementById('backToLobbyBtn');
            if (backBtn) {
                backBtn.style.display = 'inline-block';
                backBtn.textContent = '게임 종료 - 로비로';
            }
        });

        socket.on('round1Ended', (data) => {
            console.log('1라운드 종료:', data);
            updateGameState(data.finalState);
            showMessage(data.message);
            updateGamePhase('1라운드 완료');
        });

        // 게임 중지 이벤트 핸들러
        socket.on('gameStopped', (data) => {
            console.log('게임 중지:', data);
            updateGameState(data.gameState);
            showMessage(`🛑 ${data.message}`, 'danger');
            updateGamePhase('게임 중지됨');
            
            // 즉시 알림을 보여주고 3초 후 로비로 리다이렉트
            alert(`🛑 ${data.message}\n\n3초 후 로비로 돌아갑니다.`);
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        });

        // 플레이어 연결 끊김 이벤트
        socket.on('playerDisconnected', (data) => {
            console.log('플레이어 연결 끊김:', data);
            if (data.gameState) {
                updateGameState(data.gameState);
            }
            showMessage(data.message, 'warning');
        });
        
        // 플레이어 재연결 이벤트
        socket.on('playerReconnected', (data) => {
            console.log('플레이어 재연결:', data);
            if (data.gameState) {
                updateGameState(data.gameState);
            }
            showMessage(data.message, 'success');
        });

        // 개인 게임 상태 복원 이벤트 (재접속 시)
        socket.on('personalGameState', (data) => {
            console.log('개인 게임 상태 복원:', data);

            // 칩 정보 복원
            if (data.chips && data.chips.length > 0) {
                console.log('칩 정보 복원:', data.chips);
                // 칩 정보는 gameStateUpdate에서 처리됨
            }

            // 패스 상태 복원
            if (data.passed !== undefined) {
                console.log('패스 상태 복원:', data.passed);
                // UI 업데이트는 gameStateUpdate에서 처리됨
            }

            // 준비 상태 복원
            if (data.ready !== undefined) {
                console.log('준비 상태 복원:', data.ready);
            }
        });

        // 턴 정보 이벤트 (재접속 시)
        socket.on('turnInfo', (data) => {
            console.log('턴 정보 수신:', data);
            if (data.currentPlayerName) {
                updatePlayerTurnIndicators(data.currentPlayerName);
                if (data.isYourTurn) {
                    showMessage('당신의 차례입니다!', 'success');
                }
            }
        });

        // 플레이어 퇴장 이벤트
        socket.on('playerLeft', (data) => {
            console.log('플레이어 퇴장:', data);
            if (data.gameState) {
                updateGameState(data.gameState);
            }
            showMessage(`${data.username}님이 방을 나갔습니다.`, 'info');
        });

        socket.on('error', (data) => {
            console.error('소켓 오류:', data);

            // 구조화된 에러 처리
            const errorMessage = data.userMessage || data.message || '알 수 없는 오류가 발생했습니다.';
            const errorType = data.type || 'UNKNOWN';
            const canRetry = data.canRetry || false;

            console.error(`[Error Type: ${errorType}] ${data.message || errorMessage}`);

            // 에러 타입별 처리
            if (errorType === 'VALIDATION') {
                showMessage(`⚠️ ${errorMessage}`, 'error');
            } else if (errorType === 'PERMISSION') {
                showMessage(`🚫 ${errorMessage}`, 'error');
            } else if (errorType === 'STATE') {
                showMessage(`❌ ${errorMessage}`, 'error');
                // 상태 에러는 게임 상태 재요청
                if (gameState?.roomId) {
                    socket.emit('requestGameState', { roomId: gameState.roomId });
                }
            } else if (errorType === 'NETWORK') {
                showMessage(`🔄 ${errorMessage}`, 'error');
            } else {
                showMessage(errorMessage, 'error');
            }

            // 재시도 가능한 에러는 콘솔에 표시
            if (canRetry) {
                console.log('[Info] 이 오류는 재시도 가능합니다.');
            }
        });

        // 세션 대체 이벤트 (다른 브라우저에서 접속 시)
        socket.on('sessionReplaced', (data) => {
            console.warn('세션 대체됨:', data);
            alert('다른 기기에서 로그인이 감지되었습니다.');
            // 로그인 페이지로 리다이렉트
            window.location.href = '/login.html';
        });

        // 방 폭파 알림
        socket.on('roomDestroyed', (data) => {
            console.log('[Room Destroyed]', data);
            showMessage(`💥 ${data.message}`, 'warning');
            
            // 3초 후 로비로 자동 이동
            setTimeout(() => {
                alert(`방이 폭파되어 로비로 돌아갑니다.`);
                window.location.href = '/';
            }, 3000);
        });

        socket.on('gameStarted', (data) => {
            console.log('게임이 시작되었습니다:', data);
            if (data.gameId) {
                gameState.gameId = data.gameId;
            }
            showMessage('게임이 시작되었습니다! 1라운드가 곧 시작됩니다...');
            updateGamePhase('게임 시작');
        });
    }
    
    function updateGameState(state) {
        console.log('updateGameState 호출됨:', state);
        
        // state가 없으면 리턴
        if (!state) {
            console.error('[updateGameState] state가 undefined입니다');
            return;
        }
        
        // roomId 보존
        const existingRoomId = gameState?.roomId;
        
        // gameState가 없으면 빈 객체로 초기화
        if (!gameState) {
            gameState = {};
        }
        
        // state를 gameState에 병합
        Object.assign(gameState, state);
        
        // roomId가 없으면 기존 값 또는 URL에서 가져오기
        if (!gameState.roomId && existingRoomId) {
            gameState.roomId = existingRoomId;
        } else if (!gameState.roomId) {
            // urlParams는 전역에서 선언됨
            const urlRoomId = urlParams.get('roomId');
            if (urlRoomId) {
                gameState.roomId = urlRoomId;
            }
        }

        // The Gang 게임 상태 업데이트
        if (state.centerChips !== undefined) {  // 빈 배열도 처리하도록 수정
            console.log('[updateGameState] 중앙 칩 업데이트:', state.centerChips);
            // gameState 객체에도 centerChips 저장
            gameState.centerChips = state.centerChips;
            updateCenterChips(state.centerChips);
        }

        if (state.players) {
            console.log('[updateGameState] 플레이어 업데이트:', state.players);
            // gameState 객체에도 players 저장
            gameState.players = state.players;
            updatePlayerChips(state.players);
            updatePlayers(state.players);
        }

        if (state.currentRound) {
            updateRoundInfo(state.currentRound, state.maxRounds || 5);
        }

        if (state.phase) {
            updateGamePhase(state.phase);

            // 쇼다운이 아닌 페이즈로 돌아올 때 UI 복원
            if (state.phase !== 'showdown') {
                const showdownContainer = document.getElementById('showdownContainer');
                if (showdownContainer) {
                    showdownContainer.classList.remove('active');
                }

                const playersGrid = document.querySelector('.players-grid');
                if (playersGrid) {
                    playersGrid.style.display = '';
                }

                const chipsContainer = document.getElementById('casinoChipsContainer');
                if (chipsContainer) {
                    chipsContainer.style.display = '';
                }

                // 금고/경보 카운터는 항상 표시 (숨기지 않음)
            }
        }

        // 현재 플레이어 표시 업데이트
        if (state.currentPlayer !== undefined && state.players) {
            const currentPlayerData = state.players[state.currentPlayer];
            if (currentPlayerData) {
                showMessage(`현재 턴: ${currentPlayerData.username}`);
                
                // 현재 플레이어 표시 업데이트
                const currentUsername = getCurrentUsername();
                // isMyTurn = (currentPlayerData.username === currentUsername); // 실시간 게임으로 변경
                
                // 턴 표시 UI 업데이트
                updatePlayerTurnIndicators(currentPlayerData.username);
            }
        }

        console.log('updateGameState 완료:', state);
        
        if (!gameState.collectedChips) {
            gameState.collectedChips = [];
        }
        
        // 게임이 새로 시작되거나 라운드가 변경될 때 클라이언트 측 칩 수집 변수 초기화
        if (state.phase === 'waiting' || state.phase === 'dealing' || 
            (gameState.phase !== state.phase && state.phase === 'playing')) {
            myCollectedChipIndex = null;
            console.log('게임 상태 변경으로 칩 수집 변수 초기화됨');
        }
        
        currentPlayer = state.currentPlayer;
        // isMyTurn = state.isMyTurn; // 실시간 게임으로 변경
        
        console.log('updateCommunityCards 호출 전 - 커뮤니티 카드:', state.communityCards);
        updateCommunityCards(state.communityCards);
        updatePlayers(state.players);
        updateControls();
        updateGamePhase(state.phase);
        updateRoundInfo(state.currentRound, state.maxRounds);
        
        // 방 정보 업데이트 - state 자체가 방 정보를 포함하고 있음
        updateRoomInfo(state);
        
        const dealCardsBtn = document.getElementById('dealCardsBtn');
        // 카드 받기 버튼 제거됨
        if (false && dealCardsBtn) {
            // 여러 방법으로 현재 사용자 확인
            const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                   sessionStorage.getItem('username') || window.currentUser;
            
            // 본인이 카드를 받았는지 확인 (다른 사용자의 카드 보유 여부와 무관)
            const myPlayer = state?.players?.find(p => p.username === currentUsername);
            const myHasCards = myPlayer && myPlayer.cards && myPlayer.cards.length > 0;
            
            if (state?.phase === 'playing') {
                if (myHasCards) {
                    // 본인이 카드를 받았으면 비활성화
                    dealCardsBtn.disabled = true;
                    dealCardsBtn.textContent = '카드 받기 완료';
                    dealCardsBtn.style.opacity = '0.6';
                    dealCardsBtn.style.display = 'inline-block';
                } else {
                    // 본인이 카드를 받지 않았으면 활성화 유지
                    dealCardsBtn.disabled = false;
                    dealCardsBtn.style.opacity = '1';
                    dealCardsBtn.style.display = 'inline-block';
                    
                    // 진행 상황 표시 (이미 설정되어 있지 않다면 기본 텍스트)
                    if (!dealCardsBtn.textContent.includes('(')) {
                        dealCardsBtn.textContent = '카드 받기';
                    }
                }
            }
        }
    }
    

    
    function updateCommunityCards(cards) {
        console.log('updateCommunityCards 호출됨 - 받은 카드:', cards);
        const container = document.getElementById('communityCards');
        if (!container) {
            console.error('communityCards 컨테이너를 찾을 수 없습니다!');
            return;
        }

        // 카드가 없거나 빈 배열이면 아무것도 하지 않음 (기존 카드 유지)
        if (!cards || !Array.isArray(cards) || cards.length === 0) {
            console.log('유효하지 않거나 빈 카드 데이터 - 기존 카드 유지:', cards);
            return;
        }

        console.log('커뮤니티 카드 컨테이너 발견, 기존 내용 제거');
        container.innerHTML = '';

        console.log(`${cards.length}장의 커뮤니티 카드 표시 시작`);
        cards.forEach((card, index) => {
            console.log(`커뮤니티 카드 ${index + 1}: ${card.rank}${card.suit}`);
            const cardElement = createCardElement(card);
            container.appendChild(cardElement);
        });

        console.log('커뮤니티 카드 업데이트 완료');
    }
    
         function updatePlayers(players) {
         console.log('updatePlayers 호출됨:', players);
         console.log('현재 gameState.collectedChips:', gameState?.collectedChips);
         console.log('현재 myCollectedChipIndex:', myCollectedChipIndex);
         
         // 현재 사용자 식별
         const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                sessionStorage.getItem('username') || window.currentUser;
         console.log('현재 사용자명:', currentUsername);
         
         // 모든 플레이어 표시 (자신 포함)
         const allPlayersContainer = document.getElementById('allPlayersList');
         console.log('allPlayersContainer:', allPlayersContainer);
         console.log('allPlayersContainer style:', allPlayersContainer ? allPlayersContainer.style : 'null');
         console.log('allPlayersContainer computed style:', allPlayersContainer ? getComputedStyle(allPlayersContainer).display : 'null');
         
         if (!allPlayersContainer) {
             console.error('allPlayersList 컨테이너를 찾을 수 없습니다!');
             return;
         }
         
         allPlayersContainer.innerHTML = '';
         console.log('플레이어 요소 생성 시작...');
         console.log('받은 플레이어 데이터:', players);
         
         players.forEach((player, index) => {
             console.log(`플레이어 ${index + 1} 요소 생성:`, player.username);
             const playerElement = createAllPlayerElement(player, currentUsername);
             allPlayersContainer.appendChild(playerElement);
         });
         
         console.log('모든 플레이어 요소 생성 완료');
         
         // 내 플레이어 영역 업데이트 (기존 유지)
         const myPlayer = players.find(p => p.username === currentUsername);
         if (myPlayer) {
             console.log('내 플레이어 정보 업데이트 시작');
             updateMyPlayer(myPlayer);
             console.log('내 플레이어 정보 업데이트 완료');
         }
         
         // 플레이어 수 업데이트
         const playerCountEl = document.getElementById('playerCount');
         if (playerCountEl) {
             playerCountEl.textContent = players.length;
         }
         
         // 카지노 칩 업데이트
         const collectedChips = gameState?.collectedChips || [];
         console.log('카지노 칩 업데이트 시작, collectedChips:', collectedChips);
         // updateCasinoChips(players.length, collectedChips); // 비활성화: updateCenterChips 사용
         console.log('카지노 칩 업데이트 완료');
         
         console.log('updatePlayers 완료');
     }
    
         // 쇼다운 결과 렌더링 함수
         function renderShowdown(data) {
             console.log('[renderShowdown] 시작:', data);

             // 1. 게임 페이즈 업데이트
             updateGamePhase('🎭 쇼다운');

             // 2. 플레이어 영역 숨기기
             const playersGrid = document.querySelector('.players-grid');
             if (playersGrid) {
                 playersGrid.style.display = 'none';
             }

             // 3. 카지노 칩 컨테이너 숨기기
             const chipsContainer = document.getElementById('casinoChipsContainer');
             if (chipsContainer) {
                 chipsContainer.style.display = 'none';
             }

             // 4. 쇼다운 컨테이너 표시
             const showdownContainer = document.getElementById('showdownContainer');
             if (!showdownContainer) {
                 console.error('[renderShowdown] 쇼다운 컨테이너를 찾을 수 없습니다');
                 return;
             }

             showdownContainer.classList.add('active');

             // 5. 금고/경보 카운터 업데이트
             const vaultCountEl = document.getElementById('vaultCount');
             const alarmCountEl = document.getElementById('alarmCount');
             if (vaultCountEl) vaultCountEl.textContent = data.currentVaults || 0;
             if (alarmCountEl) alarmCountEl.textContent = data.currentAlarms || 0;

             // 6. 플레이어별 쇼다운 정보 렌더링
             const playersContainer = document.getElementById('showdownPlayersContainer');
             if (!playersContainer) {
                 console.error('[renderShowdown] showdownPlayersContainer를 찾을 수 없습니다');
                 return;
             }
             playersContainer.innerHTML = '';

             if (data.showdownPlayers && data.showdownPlayers.length > 0) {
                 data.showdownPlayers.forEach((player, index) => {
                     const playerRow = document.createElement('div');
                     playerRow.className = 'showdown-player-row';

                     // === 첫 번째 칸: 아이디 + 칩 ===
                     const column1 = document.createElement('div');
                     column1.className = 'showdown-column-1';

                     // 플레이어 이름 (첫 줄)
                     const playerName = document.createElement('div');
                     playerName.className = 'showdown-player-name';
                     playerName.textContent = player.username;
                     column1.appendChild(playerName);

                     // 빨간 칩 (두 번째 줄)
                     const redChip = document.createElement('div');
                     redChip.className = 'showdown-red-chip';
                     redChip.textContent = `${player.redChipStars}★`;
                     column1.appendChild(redChip);

                     playerRow.appendChild(column1);

                     // === 두 번째 칸: 카드 2장 ===
                     const column2 = document.createElement('div');
                     column2.className = 'showdown-column-2';

                     const pocketCards = document.createElement('div');
                     pocketCards.className = 'showdown-pocket-cards';
                     if (player.pocketCards && player.pocketCards.length === 2) {
                         player.pocketCards.forEach(card => {
                             const cardEl = createCardElement(card);
                             pocketCards.appendChild(cardEl);
                         });
                     }
                     column2.appendChild(pocketCards);

                     playerRow.appendChild(column2);

                     // === 세 번째 칸: 포커핸드 + 성공/실패 ===
                     const column3 = document.createElement('div');
                     column3.className = 'showdown-column-3';

                     // 포커 핸드 이름 (첫 줄)
                     const handName = document.createElement('div');
                     handName.className = 'showdown-hand-name';
                     handName.textContent = player.handName || 'Unknown';
                     if (player.tied) {
                         handName.textContent += ' (동점)';
                     }
                     column3.appendChild(handName);

                     // 성공/실패 배지 (두 번째 줄)
                     const resultBadge = document.createElement('div');
                     resultBadge.className = 'showdown-result-badge';
                     if (player.isCorrect) {
                         resultBadge.classList.add('success');
                         resultBadge.textContent = '✅';

                         // 성공 효과: 행 전체에 황금빛 효과 추가
                         playerRow.classList.add('success-effect');

                         // 코인 터지는 효과 추가 (배지 위치에서)
                         setTimeout(() => {
                             createCoinBurst(resultBadge);
                         }, 500);
                     } else {
                         resultBadge.classList.add('fail');
                         resultBadge.textContent = '❌';

                         // 실패 효과: 행 전체에 어두운 효과 추가
                         playerRow.classList.add('fail-effect');

                         // 카드를 회색으로 변경
                         pocketCards.classList.add('failed');
                     }
                     column3.appendChild(resultBadge);

                     playerRow.appendChild(column3);

                     playersContainer.appendChild(playerRow);
                 });
             }

             // 7. 확인 버튼 이벤트 리스너 추가
             const confirmBtn = document.getElementById('confirmShowdownBtn');
             if (confirmBtn) {
                 // 기존 이벤트 리스너 제거 (중복 방지)
                 const newBtn = confirmBtn.cloneNode(true);
                 confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);

                 // 버튼 초기 상태로 리셋
                 newBtn.disabled = false;

                 newBtn.addEventListener('click', () => {
                     console.log('[Confirm] 쇼다운 확인 버튼 클릭');
                     newBtn.disabled = true;
                     socket.emit('confirmShowdown', { roomId: gameState.roomId });
                 });
             }

             // 8. 진행 상황 초기화
             const progressEl = document.getElementById('confirmProgress');
             if (progressEl) {
                 progressEl.textContent = '대기중: 0명 확인';
             }

             // 9. 결과 메시지 표시
             if (data.message) {
                 showMessage(data.message);
             }

             // 10. 금고/경보 수 업데이트
             console.log(`[renderShowdown] 금고: ${data.currentVaults}, 경보: ${data.currentAlarms}`);

             // 11. gameState에 쇼다운 페이즈 저장 (updateGameState가 호출되어도 UI 유지)
             gameState.phase = 'showdown';
         }

         function createCardElement(card) {
         console.log('createCardElement 호출됨, 카드:', card);
         
         if (!card || !card.suit) {
             console.error('카드 데이터가 유효하지 않습니다:', card);
             return document.createElement('div');
         }
         
         const cardDiv = document.createElement('div');
         const suitSymbol = getSuitSymbol(card.suit);
         console.log('카드 문양 변환 결과:', card.suit, '->', suitSymbol);
         
         cardDiv.className = `card ${suitSymbol === '♥' || suitSymbol === '♦' ? 'red' : 'black'}`;
         
         if (card.hidden) {
             cardDiv.classList.add('hidden');
             cardDiv.innerHTML = '🂠';
         } else {
             console.log('커뮤니티 카드 생성:', card.rank, suitSymbol);
             cardDiv.innerHTML = `
                 <div style="font-size: 1.2rem; font-weight: bold;">${card.rank}</div>
                 <div style="font-size: 1.5rem; margin-top: 5px;">${suitSymbol}</div>
             `;
         }
         return cardDiv;
     }
    
    function createPlayerElement(player) {
        const playerDiv = document.createElement('div');
        const hasCards = player.cards && player.cards.length > 0;
        const cardStatus = hasCards ? 'has-cards' : 'no-cards';
        playerDiv.className = `player ${player.isCurrent ? 'current' : ''} ${cardStatus}`;
        
        let collectedChipsIcons = '';
        if (gameState && gameState.collectedChips && gameState.collectedChips.length > 0) {
            collectedChipsIcons = `
                <div class="collected-chips-icons">
                    ${gameState.collectedChips.map(chipIndex => {
                        // 칩의 실제 별 개수 계산 (칩 인덱스 + 1)
                        const starCount = chipIndex + 1;
                        
                        // 별들을 표시하는 HTML 생성
                        let starsHTML = '';
                        for (let j = 0; j < starCount; j++) {
                            let starSize = '12px'; // 기본 크기
                            if (starCount > 4) {
                                starSize = '8px';
                            } else if (starCount > 2) {
                                starSize = '9px';
                            }
                            starsHTML += `<span style="font-size: ${starSize}; animation-delay: ${j * 0.2}s;">★</span>`;
                        }
                        
                        return `
                            <div class="collected-chip-icon" data-chip-index="${chipIndex}" title="칩 ${chipIndex + 1} (${starCount}개 별)">
                                <div class="chip-icon-inner">
                                    <span class="chip-number">${chipIndex + 1}</span>
                                    <div class="chip-stars-display" style="margin-top: 2px; text-align: center;">
                                        ${starsHTML}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // 패스 상태 표시 아이콘
        const passStatusIcon = player.hasPassed ? 
            '<span class="pass-status-icon passed" title="패스함">✓</span>' : 
            '<span class="pass-status-icon active" title="게임 중">🎮</span>';
        
        playerDiv.innerHTML = `
            <div class="player-info">
                <div class="player-name">
                    ${player.username}
                    ${passStatusIcon}
            </div>
        </div>
            <div class="player-cards-container">
                <div class="player-cards">
                    ${player.cards.map(card => {
                        const cardElement = createCardElement(card);
                        return cardElement.outerHTML;
                    }).join('')}
    </div>
                ${collectedChipsIcons}
    </div>
        `;
        return playerDiv;
    }
    
         // 모든 플레이어 요소 생성 (자신과 다른 플레이어 구분)
     function createAllPlayerElement(player, currentUsername) {
         const isCurrentUser = player.username === currentUsername;
         const playerDiv = document.createElement('div');
         const hasCards = player.cards && player.cards.length > 0;
         const cardStatus = hasCards ? 'has-cards' : 'no-cards';
         const isOnline = player.isOnline !== false; // 온라인 상태 확인
         
         console.log(`플레이어 ${player.username} 요소 생성:`, {
             isCurrentUser,
             hasCards,
             cardStatus,
             cards: player.cards,
             isOnline
         });
         
         // 자신과 다른 플레이어를 구분하여 클래스 설정
         const passedClass = player.hasPassed || player.passed ? 'passed' : '';
         if (isCurrentUser) {
             playerDiv.className = `all-player current-user ${cardStatus} ${passedClass} ${!isOnline ? 'offline' : ''}`;
         } else {
             playerDiv.className = `all-player other-user ${cardStatus} ${passedClass} ${!isOnline ? 'offline' : ''}`;
         }
         
         // 패스 상태 표시 아이콘
         const passStatusIcon = player.hasPassed ? 
             '<span class="pass-status-icon passed" title="패스함">✓</span>' : 
             '<span class="pass-status-icon active" title="게임 중">🎮</span>';
         
         // 카드 상태 표시 아이콘
         const cardStatusIcon = hasCards ? 
             '<span class="card-status-icon ready" title="카드 보유">✓</span>' : 
             '<span class="card-status-icon waiting" title="카드 대기 중">⏳</span>';
         
                   // 수집된 칩 표시 (각 플레이어가 가져간 실제 칩 표시)
          let chipIcons = '';
          
          console.log(`플레이어 ${player.username} 칩 표시 로직:`, {
             isCurrentUser,
             playerChips: player.chips
          });
          
          // 라운드별로 수집된 칩들 표시
          let allChipsToDisplay = [];
          
          // 이전 라운드 칩들 (요약판에만 표시)
          if (player.roundChips) {
              for (let round in player.roundChips) {
                  if (player.roundChips[round] && player.roundChips[round].length > 0) {
                      allChipsToDisplay = allChipsToDisplay.concat(player.roundChips[round]);
                  }
              }
          }
          
          // 현재 라운드 칩들
          if (player.chips && player.chips.length > 0) {
              allChipsToDisplay = allChipsToDisplay.concat(player.chips);
          }
          
          // 플레이어가 가져간 칩들을 별 디자인으로 표시
          if (allChipsToDisplay.length > 0) {
              let chipsHTML = '';
              allChipsToDisplay.forEach((chip, index) => {
                  const starCount = chip.stars || chip.value || (index + 1);
                  let starsHTML = '';
                  for (let j = 0; j < starCount; j++) {
                      starsHTML += `<div class="chip-star" style="
                          font-size: 6px;
                          color: black;
                          text-shadow: 0 0 1px rgba(255,255,255,0.8);
                          animation: sparkle 2s infinite;
                          animation-delay: ${j * 0.2}s;
                          line-height: 1;
                      ">★</div>`;
                  }

                  const chipId = String(chip.id || '').replace(/'/g, "\\'");
                  const playerName = String(player.username || '').replace(/'/g, "\\'");

                  chipsHTML += `
                      <div class="casino-chip summary-chip ${chip.color}"
                           data-chip-id="${chip.id}"
                           data-chip-index="${index}"
                           onclick="handleChipClick('${chipId}', 'player', '${playerName}')"
                           title="칩 ${chip.id} (값: ${chip.value}, 별: ${starCount}개)"
                           style="
                               display: inline-block;
                               margin: 2px;
                               width: 22px;
                               height: 22px;
                               cursor: pointer;
                               transition: all 0.2s;
                           ">
                          <div class="chip-stars" style="
                              display: flex;
                              flex-wrap: wrap;
                              justify-content: center;
                              align-items: center;
                              width: 100%;
                              height: 100%;
                              gap: 0;
                          ">${starsHTML}</div>
                      </div>
                  `;
              });
              chipIcons = `<div class="all-player-chips-container">${chipsHTML}</div>`;
              console.log(`플레이어 ${player.username} 칩 표시: ${allChipsToDisplay.length}개 칩 (별 디자인)`);
          }
         
                   // 카드 표시 (자신은 실제 카드, 다른 플레이어는 뒷면)
          let cardsHTML = '';
          if (hasCards && player.cards && Array.isArray(player.cards)) {
              if (isCurrentUser) {
                  // 자신의 카드는 실제 내용 표시
                  cardsHTML = player.cards.map(card => {
                      if (!card) return '';
                      console.log('카드 정보:', card);
                      const suitSymbol = getSuitSymbol(card.suit);
                      const isRed = suitSymbol === '♥' || suitSymbol === '♦';
                      console.log('카드 생성:', card.rank, suitSymbol, isRed ? 'red' : 'black');
                      return `<div class="all-player-card ${isRed ? 'red' : 'black'}">${card.rank}${suitSymbol}</div>`;
                  }).join('');
              } else {
                  // 다른 플레이어의 카드는 뒷면 표시 (내 카드도 다른 사용자에게는 뒷면으로 보임)
                  cardsHTML = player.cards.map(() => '<div class="all-player-card">🂠</div>').join('');
              }
          }
 
        // 현재 라운드 번호 가져오기
        const currentRoundNumber = gameState?.round || 1;
        console.log(`[createAllPlayerElement] ${player.username} 처리 시작 - 현재 라운드: ${currentRoundNumber}`);

        // player.chips를 현재 라운드와 이전 라운드로 분리
        let previousChips = [];
        let currentChips = [];

        if (player.chips && player.chips.length > 0) {
            console.log(`[칩 분리] ${player.username} - 현재 라운드: ${currentRoundNumber}, 전체 칩:`, player.chips);

             player.chips.forEach(chip => {
                 console.log(`  칩 확인: round=${chip.round}, locked=${chip.locked}, value=${chip.value}`);

                 // locked 속성이나 round 속성으로 이전/현재 구분
                 if (chip.locked === true) {
                     console.log(`  → 이전 칩 (locked)`);
                     previousChips.push(chip);
                 } else if (chip.round && chip.round < currentRoundNumber) {
                     console.log(`  → 이전 칩 (old round)`);
                     previousChips.push(chip);
                 } else {
                     // locked가 false이고 현재 라운드의 칩
                     console.log(`  → 현재 칩 (round=${chip.round}, current=${currentRoundNumber})`);
                     currentChips.push(chip);
                 }
             });

             console.log(`[칩 분리 결과] 이전: ${previousChips.length}개, 현재: ${currentChips.length}개`);
         }

         // player.roundChips도 확인 (혹시 서버가 따로 보낼 경우)
         if (player.roundChips) {
             for (let round in player.roundChips) {
                 if (player.roundChips[round] && player.roundChips[round].length > 0) {
                     previousChips = previousChips.concat(player.roundChips[round]);
                 }
             }
         }

         // 이전 칩 HTML 생성 (숫자로 표시)
         let previousChipsHTML = '';
         if (previousChips.length > 0) {
             previousChipsHTML = previousChips.map((chip, index) => {
                 const starCount = chip.stars || chip.value || (index + 1);
                 const chipColor = chip.color || 'white';
                 // 모두 숫자로 표시 (검은색)
                 const starsHTML = `<span style="font-size: 10px; font-weight: bold; color: #000;">${starCount}</span>`;
                 return `<div class="chip-display chip-${chipColor}" title="${starCount}개">${starsHTML}</div>`;
             }).join('');
         }

         // 현재 칩 HTML 생성 (별 디자인)
         let currentChipsHTML = '';
         if (currentChips.length > 0) {
             currentChipsHTML = currentChips.map((chip, index) => {
                 const starCount = chip.stars || chip.value || (index + 1);
                 const chipColor = chip.color || 'white';
                 // 현재 칩은 크기가 크므로 별을 여러 개 표시 가능
                 let starsHTML = '';
                 if (starCount <= 4) {
                     starsHTML = '<div style="display:flex; flex-wrap:wrap; width:100%; height:100%; align-items:center; justify-content:center; gap:1px;">';
                     for (let j = 0; j < starCount; j++) {
                         starsHTML += '<span style="font-size: 10px; width:calc(50% - 1px); text-align:center; color: #000;">★</span>';
                     }
                     starsHTML += '</div>';
                 } else {
                     starsHTML = `<span style="font-size: 12px; font-weight: bold;">${starCount}</span>`;
                 }
                 const chipId = String(chip.id || '').replace(/'/g, "\\'");
                 const playerName = String(player.username || '').replace(/'/g, "\\'");
                 return `<div class="chip-display chip-${chipColor}"
                              data-chip-id="${chip.id}"
                              data-chip-index="${index}"
                              onclick="handleChipClick('${chipId}', 'player', '${playerName}')"
                              title="칩 ${chip.id} (값: ${chip.value || starCount}, 별: ${starCount}개)"
                              style="cursor: pointer;">
                         ${starsHTML}
                         </div>`;
             }).join('');
         }

         console.log(`[HTML 생성] ${player.username} - 이전칩:${previousChips.length}개, 현재칩:${currentChips.length}개`);

         playerDiv.innerHTML = `
             <div class="all-player-info">
                 <div class="all-player-name" ${!isOnline ? 'style="color: #ff4444;"' : ''}>
                     ${passStatusIcon} ${player.username}${!isOnline ? ' (오프라인)' : ''}
                 </div>
                 <div class="all-player-previous-chips">
                     ${previousChipsHTML}
                 </div>
             </div>
             <div class="all-player-bottom-row">
                 <div class="all-player-cards">
                     ${cardsHTML}
                 </div>
                 <div class="all-player-current-chips">
                     ${currentChipsHTML}
                 </div>
             </div>
         `;
         
         return playerDiv;
     }
    
    // 내 플레이어 영역 업데이트
    function updateMyPlayer(player) {
        // 내 이름 업데이트
        const nameEl = document.getElementById('myPlayerName');
        if (nameEl) {
            nameEl.textContent = player.username;
        }
        
        // 내 카드 상태 업데이트
        const statusEl = document.getElementById('myCardStatus');
        const hasCards = player.cards && player.cards.length > 0;
        if (statusEl) {
            statusEl.textContent = hasCards ? '✓' : '⏳';
            statusEl.className = `card-status-icon ${hasCards ? 'ready' : 'waiting'}`;
            statusEl.title = hasCards ? '카드 보유' : '카드 대기 중';
        }
        
        // 내 플레이어 영역 스타일 업데이트
        const myAreaEl = document.getElementById('myPlayerArea');
        if (myAreaEl) {
            myAreaEl.className = `my-player-area ${hasCards ? 'has-cards' : 'no-cards'}`;
        }
        
        // 내 카드들 표시 (실제 카드 내용 표시)
        const myCardsEl = document.getElementById('myCards');
        if (myCardsEl) {
            myCardsEl.innerHTML = '';
            if (hasCards) {
                player.cards.forEach(card => {
                    const cardEl = createMyCardElement(card);
                    myCardsEl.appendChild(cardEl);
                });
            }
        }
        
        // 내 수집된 칩들은 updatePlayerChips 함수에서 처리하므로 여기서는 제거
        // updatePlayerChips에서 서버 데이터를 기반으로 올바르게 표시됨
    }
    
         // 내 카드 요소 생성 (실제 카드 내용 표시)
     function createMyCardElement(card) {
         console.log('createMyCardElement 호출됨, 카드:', card);
         
         if (!card || !card.suit) {
             console.error('내 카드 데이터가 유효하지 않습니다:', card);
             return document.createElement('div');
         }
         
         const cardDiv = document.createElement('div');
         const suitSymbol = getSuitSymbol(card.suit);
         const isRed = suitSymbol === '♥' || suitSymbol === '♦';
         cardDiv.className = `my-card ${isRed ? 'red' : 'black'}`;
         
         console.log('내 카드 생성:', card.rank, suitSymbol, isRed ? 'red' : 'black');
         
         cardDiv.innerHTML = `
             <div class="my-card-top">${card.rank}</div>
             <div class="my-card-suit">${suitSymbol}</div>
             <div class="my-card-bottom">${card.rank}</div>
         `;
         
         return cardDiv;
     }
    
    function updateControls() {
        const gameActionBtn = document.getElementById('gameActionBtn');
        const passBtn = document.getElementById('passBtn');
        
        if (gameActionBtn) {
            gameActionBtn.style.display = 'inline-block';
            
            // 패스 로직 개선: 칩을 가지고 있으면 언제든 패스 가능
            if (gameActionMode === 'pass') {
                const currentUsername = getCurrentUsername();
                const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
                const hasChips = myPlayer?.chips && myPlayer.chips.length > 0;
                
                gameActionBtn.disabled = !hasChips;
                if (hasChips) {
                    gameActionBtn.textContent = '패스';
                } else {
                    gameActionBtn.textContent = '패스 (칩 필요)';
                }
            }
        }
        
        // 패스 버튼 표시: 게임 중일 때 항상 보이도록
        const isPlayingPhase = gameState?.phase === 'playing' ||
                               gameState?.phase?.startsWith('round');
        if (passBtn && isPlayingPhase) {
            passBtn.style.display = 'inline-block';

            // 현재 사용자 찾기
            const currentUsername = (socket?.data?.username) || localStorage.getItem('username') ||
                                   sessionStorage.getItem('username') || window.currentUser;
            const myPlayer = gameState?.players?.find(p => p.username === currentUsername);

            // 패스 버튼 활성화 조건:
            // 1. 현재 사용자가 현재 라운드의 칩을 가지고 있을 때
            // 2. 현재 사용자가 아직 패스하지 않았을 때
            const currentRound = gameState?.currentRound || 1;
            let hasCurrentRoundChip = false;

            if (myPlayer?.chips && myPlayer.chips.length > 0) {
                hasCurrentRoundChip = myPlayer.chips.some(chip => chip.round === currentRound);
            }

            const hasNotPassed = !myPlayer?.hasPassed;

            passBtn.disabled = !hasCurrentRoundChip || !hasNotPassed;
        } else if (passBtn) {
            passBtn.style.display = 'none';
        }
    }
    
    function updateRoundInfo(currentRound, maxRounds) {
        const currentRoundEl = document.getElementById('currentRound');
        const maxRoundsEl = document.getElementById('maxRounds');
        
        if (currentRoundEl) {
            currentRoundEl.textContent = currentRound || '-';
        }
        
        if (maxRoundsEl) {
            maxRoundsEl.textContent = maxRounds || 5;
        }
    }
    
    function updateRoomInfo(room) {
        const roomNameEl = document.getElementById('roomName');
        const roomHostEl = document.getElementById('roomHost');
        const roomInfoCompactEl = document.querySelector('.room-info-compact');
        
        if (roomNameEl && room) {
            roomNameEl.textContent = room.name || '알 수 없음';
        }
        
        if (roomHostEl && room) {
            roomHostEl.textContent = room.host || '알 수 없음';
        }
        
        if (roomInfoCompactEl && room) {
            roomInfoCompactEl.innerHTML = `
                📍 방: ${room.name || '알 수 없음'}<br>
                👑 방장: ${room.host || '알 수 없음'}<br>
                👥 인원: ${room.players?.length || 0}/${room.maxPlayers || 4}
            `;
        }
        
        console.log('방 정보 업데이트 완료:', room);
    }
    
    // The Gang 게임 UI 업데이트 함수들
    function updateActionButtons(availableActions) {
        const gameActionBtn = document.getElementById('gameActionBtn');
        const gameControlsContainer = document.querySelector('.game-controls');
        
        if (!gameControlsContainer) return;
        
        // 기존 버튼들 제거
        gameControlsContainer.innerHTML = '';
        
        // 실시간 게임으로 변경 - 패스 버튼만 제공
        if (!availableActions || availableActions.length === 0) {
            // 패스 버튼만 제공 (칩 가져오기는 직접 클릭으로)
            availableActions = ['pass'];
        }

        // 안내 메시지 추가
        const instructionMsg = document.createElement('div');
        instructionMsg.className = 'action-instruction';
        instructionMsg.innerHTML = '💡 칩을 클릭해서 가져오거나 교환하세요!';
        instructionMsg.style.cssText = `
            color: #ffd700;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        `;
        gameControlsContainer.appendChild(instructionMsg);

        // 패스 버튼만 표시 (다른 액션은 칩 클릭으로 처리)
        const passButton = document.createElement('button');
        passButton.className = 'btn btn-warning';
        passButton.textContent = '패스';
        passButton.style.cssText = `
            background-color: #ff9800;
            border-color: #ff9800;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        `;
        passButton.onclick = () => handlePlayerAction('pass');
        gameControlsContainer.appendChild(passButton);
    }

    function showChipSelection(actionType) {
        if (!gameState || !gameState.centerChips || gameState.centerChips.length === 0) {
            showMessage('가운데에 가져올 칩이 없습니다.');
            return;
        }

        const chipId = gameState.centerChips[0].id; // 첫 번째 칩 선택 (단순화)
        handlePlayerAction(actionType, chipId);
    }

    function showPlayerSelection(actionType) {
        const currentUsername = getCurrentUsername();
        const otherPlayers = gameState.players.filter(p => 
            p.username !== currentUsername && p.chipCount > 0
        );

        if (otherPlayers.length === 0) {
            showMessage('상대할 플레이어가 없습니다.');
            return;
        }

        // 첫 번째 플레이어와 상호작용 (단순화)
        const targetPlayer = otherPlayers[0];
        const targetSocketId = targetPlayer.socketId;
        
        if (actionType === 'takeFromPlayer') {
            handlePlayerAction(actionType, { targetPlayerId: targetSocketId, chipId: 'first' });
        } else if (actionType === 'exchangeWithPlayer') {
            handlePlayerAction(actionType, { targetPlayerId: targetSocketId, myChipId: 'first', targetChipId: 'first' });
        }
    }

    function showExchangeSelection(actionType) {
        if (!gameState || !gameState.centerChips || gameState.centerChips.length === 0) {
            showMessage('가운데에 교환할 칩이 없습니다.');
            return;
        }

        const centerChipId = gameState.centerChips[0].id;
        handlePlayerAction(actionType, { myChipId: 'first', centerChipId: centerChipId });
    }

    function handlePlayerAction(action, data) {
        if (!gameState.roomId) {
            showMessage('방 ID가 없습니다.');
            return;
        }

        const actionData = {
            roomId: gameState.roomId,
            action: action,
            targetId: data
        };

        console.log('=== [CLIENT REQUEST] ===');
        console.log('Sending playerAction:', actionData);
        console.log('Action:', action);
        console.log('Target ID (chipId):', data);
        console.log('Room ID:', gameState.roomId);
        
        socket.emit('playerAction', actionData);
    }

    function handleChipClick(chipId, source, targetUsername) {
        console.log('handleChipClick 호출:', chipId, source, targetUsername);
        
        const currentUsername = getCurrentUsername();
        const myPlayer = gameState.players ? gameState.players.find(p => p.username === currentUsername) : null;
        
        if (!myPlayer) {
            showMessage('플레이어 정보를 찾을 수 없습니다.');
            return;
        }

        const hasMyChips = myPlayer.chips && myPlayer.chips.length > 0;
        
        // 요약판에서 칩 클릭 처리
        if (source === 'player' && targetUsername) {
            if (targetUsername === currentUsername) {
                // 내 칩 클릭 - 아무 동작 안 함
                return;
            }
            
            // 다른 플레이어의 칩 찾기
            const targetPlayer = gameState.players.find(p => p.username === targetUsername);
            if (!targetPlayer) {
                showMessage('대상 플레이어를 찾을 수 없습니다.');
                return;
            }
            
            // 소켓 ID 찾기
            let targetSocketId = targetPlayer.socketId || targetUsername;
            
            // 칩 정보 찾기
            const chip = targetPlayer.chips.find(c => c.id === chipId);
            if (!chip) {
                showMessage('해당 칩을 찾을 수 없습니다.');
                return;
            }
            
            // 다른 플레이어의 칩 클릭
            // 현재 라운드의 잠기지 않은 칩을 가지고 있는지 확인
            const hasUnlockedChip = myPlayer.chips && myPlayer.chips.some(c => c.locked === false);

            if (hasUnlockedChip) {
                // 현재 라운드 칩을 가지고 있으면 교환
                const myUnlockedChip = myPlayer.chips.find(c => c.locked === false);
                handlePlayerAction('exchangeWithPlayer', {
                    targetPlayerId: targetSocketId,
                    myChipId: myUnlockedChip.id,
                    targetChipId: chipId
                });
                showMessage(`${targetUsername}의 칩 ${chip.value}와 내 칩 ${myUnlockedChip.value}를 교환합니다.`);
            } else {
                // 현재 라운드 칩이 없으면 가져오기
                handlePlayerAction('takeFromPlayer', {
                    targetPlayerId: targetSocketId,
                    chipId: chipId
                });
                showMessage(`${targetUsername}에게서 칩 ${chip.value}를 가져옵니다.`);
            }
        } else if (source === 'center') {
            // 가운데 칩 클릭 처리
            const chip = gameState.centerChips ? gameState.centerChips.find(c => c.id === chipId) : null;
            if (!chip) {
                showMessage('해당 칩을 찾을 수 없습니다.');
                return;
            }

            // 현재 라운드의 잠기지 않은 칩을 가지고 있는지 확인
            const hasUnlockedChip = myPlayer.chips && myPlayer.chips.some(c => c.locked === false);

            if (hasUnlockedChip) {
                // 현재 라운드 칩을 가지고 있으면 교환
                const myUnlockedChip = myPlayer.chips.find(c => c.locked === false);
                handlePlayerAction('exchangeWithCenter', {
                    myChipId: myUnlockedChip.id,
                    centerChipId: chipId
                });
                showMessage(`가운데 칩 ${chip.value}와 내 칩 ${myUnlockedChip.value}를 교환합니다.`);
            } else {
                // 현재 라운드 칩이 없으면 가져오기
                console.log(`[CLIENT] Taking chip ${chipId} from center`);
                handlePlayerAction('takeFromCenter', chipId);
                showMessage(`가운데에서 칩 ${chip.value}를 가져오는 중...`);
            }
        }
    }

    function updateCenterChips(centerChips) {
        console.log('\n=== [updateCenterChips START] ===');
        console.log('Input centerChips:', centerChips);
        console.log('centerChips length:', centerChips?.length);
        
        const centerChipsContainer = document.querySelector('.casino-chips-container .chips-stack');
        if (!centerChipsContainer) {
            console.error('[updateCenterChips] Container not found!');
            console.error('Available elements:', document.querySelectorAll('.casino-chips-container, .chips-stack'));
            return;
        }

        console.log('[updateCenterChips] Container found:', centerChipsContainer);
        console.log('Current container HTML before clear:', centerChipsContainer.innerHTML.length);
        
        // 기존 내용 완전 제거
        centerChipsContainer.innerHTML = '';
        centerChipsContainer.textContent = ''; // 추가 보장
        
        console.log('Container cleared, current HTML length:', centerChipsContainer.innerHTML.length);

        // 칩이 없으면 메시지 표시
        if (!centerChips || centerChips.length === 0) {
            const noChipsMessage = '<div class="no-chips-message" style="text-align: center; color: #666; padding: 20px;">가운데 칩이 없습니다</div>';
            centerChipsContainer.innerHTML = noChipsMessage;
            console.log('[updateCenterChips] No chips - message set');
            console.log('Final container HTML:', centerChipsContainer.innerHTML);
            console.log('=== [updateCenterChips END - NO CHIPS] ===\n');
            return;
        }

        // 칩들을 화면에 표시 (이전 updateCasinoChips 스타일 적용)
        console.log(`[updateCenterChips] Creating ${centerChips.length} chips:`);
        centerChips.forEach((chip, index) => {
            console.log(`  Chip ${index}: ${chip.id} (${chip.color} ${chip.value})`);
            
            const chipElement = document.createElement('div');
            chipElement.className = `casino-chip ${chip.color}`; // 색상 클래스 추가
            chipElement.dataset.chipIndex = index;
            chipElement.setAttribute('data-chip-id', chip.id);
            
            // 여러 방법으로 현재 사용자 확인
            const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                   sessionStorage.getItem('username') || window.currentUser;
            
            // 현재 사용자가 카드를 받았는지 확인
            const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
            const hasMyCards = myPlayer && myPlayer.cards && myPlayer.cards.length > 0;

            // 칩이 잠겨있거나 이전 라운드 것인지 확인
            const isLocked = chip.locked === true;
            const isCurrentRound = !chip.round || chip.round === gameState?.currentRound;
            const isClickable = hasMyCards && !isLocked && isCurrentRound;

            if (isClickable) {
                chipElement.style.cursor = 'pointer';
                chipElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            } else {
                chipElement.style.opacity = '0.5';
                chipElement.style.cursor = 'not-allowed';
                chipElement.style.filter = 'grayscale(50%)';
                if (isLocked || !isCurrentRound) {
                    chipElement.title = '이전 라운드의 칩입니다';
                }
            }
            
            // 별 컨테이너 생성 (이전 방식과 동일)
            const starsContainer = document.createElement('div');
            starsContainer.className = 'chip-stars';
            
            // 각 칩마다 다른 별 개수 (chip.stars 또는 index + 1)
            const starCount = chip.stars || (index + 1);
            console.log(`칩 ${index + 1}: ${starCount}개의 별 생성`);
            
            for (let j = 0; j < starCount; j++) {
                const star = document.createElement('div');
                star.className = 'chip-star';
                star.textContent = '★';
                star.style.animationDelay = `${j * 0.2}s`;
                
                // 별이 많을 때 크기 조정
                if (starCount > 4) {
                    star.style.fontSize = '8px';
                } else if (starCount > 2) {
                    star.style.fontSize = '9px';
                } else {
                    star.style.fontSize = '12px';
                }
                
                // 별 색상을 검은색으로 설정
                star.style.color = 'black';
                star.style.textShadow = '0 0 1px rgba(255,255,255,0.8)';
                
                starsContainer.appendChild(star);
                console.log(`별 ${j + 1} 추가됨, 크기: ${star.style.fontSize}`);
            }
            
            chipElement.appendChild(starsContainer);

            // 칩 클릭 이벤트 - 새로운 방식 사용 (이전과 동일)
            chipElement.addEventListener('click', function() {
                if (!hasMyCards) {
                    showMessage('카드를 먼저 받아야 칩을 가져올 수 있습니다.');
                } else if (isLocked || !isCurrentRound) {
                    showMessage('이전 라운드의 칩은 가져올 수 없습니다.');
                } else {
                    console.log('[CENTER CHIPS] Clicking chip:', chip.id);
                    handleChipClick(chip.id, 'center', null);
                }
            });
            
            centerChipsContainer.appendChild(chipElement);
        });
    }

    function updatePlayerChips(players) {
        const currentUsername = getCurrentUsername();
        const myPlayer = players.find(p => p.username === currentUsername);

        console.log('[updatePlayerChips] 현재 플레이어 상태:', myPlayer);

        if (myPlayer) {
            const myChipsEl = document.getElementById('myChips');
            if (myChipsEl) {
                myChipsEl.innerHTML = '';

                if (myPlayer.chips && myPlayer.chips.length > 0) {
                    console.log('[updatePlayerChips] 내 칩 목록:', myPlayer.chips);

                    myPlayer.chips.forEach((chip, index) => {
                        const chipEl = document.createElement('div');
                        chipEl.className = `casino-chip my-chip ${chip.color}`; // 색상 클래스 추가
                        chipEl.dataset.chipIndex = index;
                        chipEl.setAttribute('data-chip-id', chip.id);

                        // 칩이 잠겨있거나 이전 라운드 것인지 확인
                        const isLocked = chip.locked === true;
                        const isCurrentRound = !chip.round || chip.round === gameState?.currentRound;

                        if (isLocked || !isCurrentRound) {
                            chipEl.style.opacity = '0.6';
                            chipEl.style.border = '2px dashed #666';
                            chipEl.title = `라운드 ${chip.round} 칩 (잠김)`;
                        }

                        // 별 컨테이너 생성 (중앙 칩과 동일한 방식)
                        const starsContainer = document.createElement('div');
                        starsContainer.className = 'chip-stars';

                        // 각 칩마다 다른 별 개수 (chip.stars 또는 chip.value)
                        const starCount = chip.stars || chip.value || (index + 1);
                        console.log(`내 칩 ${index + 1}: ${starCount}개의 별 생성`);

                        for (let j = 0; j < starCount; j++) {
                            const star = document.createElement('div');
                            star.className = 'chip-star';
                            star.textContent = '★';
                            star.style.animationDelay = `${j * 0.2}s`;

                            // 별이 많을 때 크기 조정
                            if (starCount > 4) {
                                star.style.fontSize = '6px';
                            } else if (starCount > 2) {
                                star.style.fontSize = '8px';
                            } else {
                                star.style.fontSize = '10px';
                            }

                            // 별 색상을 검은색으로 설정
                            star.style.color = 'black';
                            star.style.textShadow = '0 0 1px rgba(255,255,255,0.8)';

                            starsContainer.appendChild(star);
                        }

                        chipEl.appendChild(starsContainer);
                        myChipsEl.appendChild(chipEl);
                    });
                } else {
                    myChipsEl.innerHTML = '<div class="no-chips">칩이 없습니다</div>';
                }
            }
        }

        // 다른 플레이어들의 칩 표시 (상단 요약창)
        const allPlayersEl = document.getElementById('allPlayersList');
        if (allPlayersEl && players) {
            players.forEach(player => {
                const playerEl = allPlayersEl.querySelector(`[data-username="${player.username}"]`);
                if (playerEl) {
                    let chipInfo = playerEl.querySelector('.chip-info');
                    if (!chipInfo) {
                        chipInfo = document.createElement('div');
                        chipInfo.className = 'chip-info';
                        playerEl.appendChild(chipInfo);
                    }
                    
                    chipInfo.innerHTML = '';
                    
                    if (player.chips && player.chips.length > 0) {
                        const chipsContainer = document.createElement('div');
                        chipsContainer.className = 'player-chips-display';
                        chipsContainer.style.cssText = `
                            display: flex;
                            gap: 2px;
                            margin-top: 4px;
                            flex-wrap: wrap;
                        `;
                        
                        player.chips.forEach((chip, index) => {
                            const chipEl = document.createElement('div');
                            chipEl.className = 'casino-chip player-chip'; // 별 디자인을 위해 casino-chip 클래스 추가
                            chipEl.dataset.chipIndex = index;
                            chipEl.setAttribute('data-chip-id', chip.id);
                            chipEl.setAttribute('data-player-username', player.username);
                            
                            // CSS 스타일을 작은 크기로 조정
                            chipEl.style.cssText = `
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                                transition: all 0.2s;
                                margin: 1px;
                            `;
                            
                            // 별 컨테이너 생성 (중앙 칩과 동일한 방식이지만 작은 크기)
                            const starsContainer = document.createElement('div');
                            starsContainer.className = 'chip-stars';
                            starsContainer.style.cssText = `
                                display: flex;
                                flex-wrap: wrap;
                                justify-content: center;
                                align-items: center;
                                width: 100%;
                                height: 100%;
                                gap: 0;
                            `;
                            
                            // 각 칩마다 다른 별 개수 (chip.stars 또는 chip.value)
                            const starCount = chip.stars || chip.value || (index + 1);
                            console.log(`플레이어 ${player.username} 칩 ${index + 1}: ${starCount}개의 별 생성`);
                            
                            for (let j = 0; j < starCount; j++) {
                                const star = document.createElement('div');
                                star.className = 'chip-star';
                                star.textContent = '★';
                                star.style.cssText = `
                                    font-size: 4px;
                                    color: black;
                                    text-shadow: 0 0 1px rgba(255,255,255,0.8);
                                    animation: sparkle 2s infinite;
                                    animation-delay: ${j * 0.2}s;
                                    line-height: 1;
                                `;
                                
                                starsContainer.appendChild(star);
                            }
                            
                            chipEl.appendChild(starsContainer);
                            
                            // 클릭 이벤트 추가 (내 턴이고 내가 아닌 경우에만)
                            if (player.username !== currentUsername) {
                                chipEl.addEventListener('click', () => handleChipClick('player', chip, player));
                                chipEl.addEventListener('mouseenter', () => {
                                    chipEl.style.transform = 'scale(1.2)';
                                    chipEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                                });
                                chipEl.addEventListener('mouseleave', () => {
                                    chipEl.style.transform = 'scale(1)';
                                    chipEl.style.boxShadow = 'none';
                                });
                            }
                            
                            chipsContainer.appendChild(chipEl);
                        });
                        
                        chipInfo.appendChild(chipsContainer);
                    } else {
                        chipInfo.innerHTML = '<div class="no-chips-small">칩 없음</div>';
                    }
                }
            });
        }
    }

    function getChipColor(color) {
        const colors = {
            'blue': '#4285f4',
            'red': '#ea4335',
            'green': '#34a853',
            'yellow': '#fbbc04',
            'purple': '#9c27b0',
            'orange': '#ff9800',
            'white': '#ffffff'
        };
        return colors[color] || '#666';
    }

    function getChipStyle(color) {
        const baseStyle = {
            background: getChipColor(color),
            color: color === 'white' ? '#000' : '#fff',
            border: color === 'white' ? '2px solid #333' : '1px solid rgba(255,255,255,0.2)'
        };
        return baseStyle;
    }

    function getCurrentUsername() {
        return localStorage.getItem('username') || 
               sessionStorage.getItem('username') || 
               window.currentUser || 
               socket.data?.username;
    }

    function updatePlayerTurnIndicators(currentPlayerUsername) {
        // 모든 플레이어 요소에서 턴 표시 제거
        const allPlayerElements = document.querySelectorAll('[data-username]');
        allPlayerElements.forEach(playerEl => {
            playerEl.classList.remove('current-turn');
            const turnIndicator = playerEl.querySelector('.turn-indicator');
            if (turnIndicator) {
                turnIndicator.remove();
            }
        });

        // 현재 턴 플레이어에게 표시 추가
        const currentPlayerEl = document.querySelector(`[data-username="${currentPlayerUsername}"]`);
        if (currentPlayerEl) {
            currentPlayerEl.classList.add('current-turn');
            
            const turnIndicator = document.createElement('div');
            turnIndicator.className = 'turn-indicator';
            turnIndicator.textContent = '👈 현재 턴';
            turnIndicator.style.cssText = `
                color: #ffd700;
                font-weight: bold;
                font-size: 12px;
                margin-left: 10px;
                animation: blink 1s infinite;
            `;
            currentPlayerEl.appendChild(turnIndicator);
        }

        console.log('턴 표시 업데이트:', currentPlayerUsername);
    }

    function updateGamePhase(phase) {
         const phaseNames = {
             'preflop': '프리플랍',
             'flop': '플랍',
             'turn': '턴',
             'river': '리버',
             'showdown': '쇼다운',
             'playing': '게임 진행 중'
         };
         document.getElementById('gamePhase').textContent = phaseNames[phase] || phase;
     }
     

    

    
    function showMessage(message) {
        // 게임 메시지 창이 제거되어 콘솔에만 출력
        console.log('Game Message:', message);
    }

    function showGameOver(result) {
        const message = `게임 종료! ${result.winner}님이 승리했습니다!`;
        console.log('Game Over:', message);
        setTimeout(() => { window.location.href = '/lobby.html'; }, 3000);
    }

    // 코인 터지는 효과 함수
    function createCoinBurst(targetElement) {
        const rect = targetElement.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        // 12개의 코인을 원형으로 퍼뜨림
        const coinCount = 12;
        for (let i = 0; i < coinCount; i++) {
            const coin = document.createElement('div');
            coin.className = 'coin-burst';

            // 원형으로 퍼지는 각도 계산
            const angle = (i / coinCount) * Math.PI * 2;
            const distance = 80 + Math.random() * 40; // 80-120px 거리
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;

            coin.style.cssText = `
                position: fixed;
                left: ${centerX}px;
                top: ${centerY}px;
                --tx: ${tx}px;
                --ty: ${ty}px;
                z-index: 9999;
            `;

            document.body.appendChild(coin);

            // 애니메이션 끝나면 제거
            setTimeout(() => {
                coin.remove();
            }, 1000);
        }
    }

         let cardsDealRequested = false; // 개별 사용자의 카드 받기 요청 상태
     let gameActionMode = 'deal'; // 'deal' 또는 'pass'
     
     // 카드 문양 변환 함수
     function getSuitSymbol(suit) {
         console.log('getSuitSymbol 호출됨, suit:', suit, 'type:', typeof suit);
         
         // suit가 undefined나 null인 경우 처리
         if (!suit) {
             console.warn('suit가 undefined 또는 null입니다:', suit);
             return '?';
         }
         
         // 문자열로 변환
         const suitStr = String(suit).toLowerCase().trim();
         console.log('정규화된 suit:', suitStr);
         
         const suitMap = {
             'h': '♥', // 하트
             'd': '♦', // 다이아몬드
             'c': '♣', // 클럽
             's': '♠'  // 스페이드
         };
         
         const result = suitMap[suitStr] || suitStr;
         console.log('변환 결과:', result);
         return result;
     }
    
    // 통합된 게임 액션 함수
    // 카드 받기 기능 제거로 인해 비활성화
    function handleGameAction() {
        console.log('handleGameAction 함수는 실시간 게임으로 인해 비활성화됨');
        // 실시간 게임에서는 사용하지 않음
        return;
    }

    // The Gang 1라운드 시작 함수
    function startRound1() {
        if (!gameState.roomId) {
            showMessage('방 ID가 없습니다.');
            return;
        }

        console.log('1라운드 시작 요청 전송');
        socket.emit('startRound1', { roomId: gameState.roomId });
    }
    
    // 버튼을 패스 모드로 전환하는 함수
    function switchToPassMode() {
        const btn = document.getElementById('gameActionBtn');
        if (btn) {
            gameActionMode = 'pass';
            btn.textContent = '패스';
            btn.className = 'btn btn-info pass-mode';
            
            // 수집된 칩이 있는지 확인해서 버튼 활성화/비활성화
            const hasCollectedChips = gameState?.collectedChips && gameState.collectedChips.length > 0;
            btn.disabled = !hasCollectedChips;
            
            console.log('버튼이 패스 모드로 전환됨, 칩 보유:', hasCollectedChips);
        }
    }
    
    // 카드 받기 기능 제거로 인해 비활성화
    function resetToDealMode() {
        console.log('resetToDealMode 함수는 실시간 게임으로 인해 비활성화됨');
        return; // 실시간 게임에서는 사용하지 않음
    }
    
    // 카드 받기 기능 제거로 인해 비활성화
    function dealCards() {
        console.log('dealCards 함수는 실시간 게임으로 인해 비활성화됨');
        return; // 실시간 게임에서는 사용하지 않음
        
        // 이미 이 사용자가 카드를 받았는지 확인 (개인별 체크)
        if (cardsDealRequested) {
            console.log('이미 카드 받기 요청을 했습니다.');
            showMessage('이미 카드를 요청했습니다.');
            return;
        }
        
        // 이미 카드를 보유하고 있는지 확인
        const myPlayer = gameState?.players?.find(p => p.username === socket.data?.username);
        if (myPlayer && myPlayer.cards && myPlayer.cards.length > 0) {
            console.log('이미 카드를 보유하고 있습니다.');
            showMessage('이미 카드를 보유하고 있습니다.');
            return;
        }
        
        // socket 연결 상태 확인
        if (!socket) {
            console.error('Socket이 연결되지 않았습니다.');
            showMessage('연결을 확인 중입니다. 잠시 후 다시 시도해주세요.');
            return;
        }
        
        let roomId = null;
        
        // 1. gameState에서 roomId 가져오기 (우선순위 1)
        if (gameState?.roomId) {
            roomId = gameState.roomId;
            console.log('gameState에서 가져온 roomId:', roomId);
        }
        
        // 2. URL에서 roomId 가져오기 (우선순위 2)
        if (!roomId) {
            // urlParams는 전역에서 선언됨
            roomId = urlParams.get('roomId');
            console.log('URL에서 가져온 roomId:', roomId);
        }
        
        // 3. socket.data에서 roomId 가져오기 (우선순위 3)
        if (!roomId && socket?.data?.roomId) {
            roomId = socket?.data?.roomId;
            console.log('socket.data에서 가져온 roomId:', roomId);
        }
        
        // roomId가 없으면 기존 대기 방에 참여하거나 새 방 생성 요청
        if (!roomId) {
            console.log('roomId를 찾을 수 없어 게임 방 찾기 또는 생성 요청...');
            socket.emit('findOrCreateGameRoom', {});
            showMessage('게임 방을 찾는 중입니다...');
            return;
        }
        
        console.log('최종 사용할 roomId:', roomId);
        
        // 이 사용자만 카드 받기 요청 상태로 변경 (다른 사용자에게 영향 없음)
        cardsDealRequested = true;
        
        // 본인만 카드 받기 버튼 임시 비활성화
        const dealCardsBtn = document.getElementById('dealCardsBtn');
        // 카드 받기 버튼 제거됨
        if (false && dealCardsBtn) {
            dealCardsBtn.disabled = true;
            dealCardsBtn.textContent = '내 카드 받는 중...';
        }
        
        // 카드 받기 애니메이션 시작
        showCardDealingAnimation();
        
        socket.emit('requestDealCards', { roomId: roomId });
        showMessage('카드를 받고 있습니다...');
    }
    
    function pass() {
        console.log('패스 버튼 클릭됨');

        // 현재 플레이어가 현재 라운드의 칩을 가지고 있는지 확인
        const currentUsername = getCurrentUsername();
        const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
        const currentRound = gameState?.currentRound || 1;

        if (!myPlayer?.chips || myPlayer.chips.length === 0) {
            showMessage('패스하려면 먼저 칩을 수집해야 합니다.');
            return;
        }

        // 현재 라운드의 칩을 가지고 있는지 확인
        const hasCurrentRoundChip = myPlayer.chips.some(chip => chip.round === currentRound);

        if (!hasCurrentRoundChip) {
            showMessage(`패스하려면 먼저 ${currentRound}라운드의 칩을 수집해야 합니다.`);
            return;
        }

        // 서버에 패스 신호 전송
        socket.emit('playerPass', {
            roomId: gameState.roomId,
            username: currentUsername
        });

        showMessage('패스했습니다!');

        const passBtn = document.getElementById('passBtn');
        if (passBtn) {
            passBtn.disabled = true;
        }
    }
    
         // 클라이언트 측에서 수집한 칩을 추적하는 변수 (전역 변수로 설정)
     let myCollectedChipIndex = null;
    
    // 칩과 별 생성 함수
    function updateCasinoChips(playerCount, collectedChips = []) {
        console.log('updateCasinoChips 호출됨:', { playerCount, collectedChips });
        
        const chipsContainer = document.getElementById('casinoChipsContainer');
        const chipsStack = chipsContainer.querySelector('.chips-stack');
        
        if (!chipsContainer || !chipsStack) {
            console.error('칩 컨테이너를 찾을 수 없음');
            return;
        }
        
        chipsStack.innerHTML = '';
        
        for (let i = 0; i < playerCount; i++) {
            const chip = document.createElement('div');
            chip.className = 'casino-chip';
            chip.dataset.chipIndex = i;
            
            const isCollected = collectedChips.includes(i);
            
                         if (isCollected) {
                 // 가져간 칩은 완전히 숨김
                 chip.style.display = 'none';
                 // return 제거 - 다음 칩으로 계속 진행
             } else {
                // 여러 방법으로 현재 사용자 확인
                const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                       sessionStorage.getItem('username') || window.currentUser;
                
                // 현재 사용자가 카드를 받았는지 확인
                const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
                const hasMyCards = myPlayer && myPlayer.cards && myPlayer.cards.length > 0;
                
                // 새로운 handleChipClick 사용
                if (hasMyCards) {
                    chip.style.cursor = 'pointer';
                    chip.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                } else {
                    chip.style.opacity = '0.5';
                    chip.style.cursor = 'not-allowed';
                    chip.style.filter = 'grayscale(50%)';
                }
                
                // 칩 클릭 이벤트 - 새로운 방식 사용
                chip.addEventListener('click', function() {
                    if (hasMyCards && gameState.centerChips && gameState.centerChips[i]) {
                        const chipId = gameState.centerChips[i].id;
                        console.log('[OLD CHIPS] Clicking chip:', chipId);
                        handleChipClick(chipId, 'center', null);
                    } else if (!hasMyCards) {
                        showMessage('카드를 먼저 받아야 칩을 가져올 수 있습니다.');
                    }
                });
            }
            
            const starsContainer = document.createElement('div');
            starsContainer.className = 'chip-stars';
            
            // 각 칩마다 다른 별 개수 (첫 번째 칩은 1개, 두 번째 칩은 2개, ...)
            const starCount = i + 1;
            console.log(`칩 ${i + 1}: ${starCount}개의 별 생성`);
            
            for (let j = 0; j < starCount; j++) {
                const star = document.createElement('div');
                star.className = 'chip-star';
                star.textContent = '★';
                star.style.animationDelay = `${j * 0.2}s`;
                
                // 별이 많을 때 크기 조정
                if (starCount > 4) {
                    star.style.fontSize = '8px';
                } else if (starCount > 2) {
                    star.style.fontSize = '9px';
                } else {
                    star.style.fontSize = '12px'; // 별이 적을 때는 더 크게
                }
                
                starsContainer.appendChild(star);
                console.log(`별 ${j + 1} 추가됨, 크기: ${star.style.fontSize}`);
            }
            
            chip.appendChild(starsContainer);
            chipsStack.appendChild(chip);
        }
    }
    
    // 칩 수집 함수
    function collectChip(chipElement, chipIndex) {
        console.log('collectChip 함수는 더 이상 사용되지 않습니다. handleChipClick을 사용하세요.');
        return;
        console.log('현재 gameState:', gameState);
        console.log('socket.data:', socket?.data);
        console.log('localStorage username:', localStorage.getItem('username'));
        
        // 여러 방법으로 현재 사용자 확인
        const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                               sessionStorage.getItem('username') || window.currentUser;
        
        console.log('확인된 현재 사용자명:', currentUsername);
        console.log('gameState.players:', gameState?.players);
        
        // 카드를 받았는지 확인
        const myPlayer = gameState?.players?.find(p => p.username === currentUsername);
        console.log('찾은 내 플레이어:', myPlayer);
        console.log('내 카드:', myPlayer?.cards);
        
        if (!myPlayer || !myPlayer.cards || myPlayer.cards.length === 0) {
            console.log('카드를 먼저 받아야 칩을 수집할 수 있습니다');
            console.log('조건 체크:', {
                myPlayer: !!myPlayer,
                hasCards: !!(myPlayer?.cards),
                cardsLength: myPlayer?.cards?.length
            });
            showMessage('카드를 먼저 받아야 칩을 수집할 수 있습니다!');
            
            // 칩을 흔들어서 시각적 피드백 제공
            chipElement.style.animation = 'chipShake 0.5s ease-in-out';
            setTimeout(() => {
                chipElement.style.animation = '';
            }, 500);
            return;
        }
        
        // 이미 칩을 수집했는지 확인 (클라이언트 측 변수 사용)
        if (myCollectedChipIndex !== null) {
            console.log('이미 칩을 수집했습니다');
            showMessage('이미 칩을 수집했습니다! 한 명당 하나의 칩만 수집할 수 있습니다.');
            
            // 칩을 흔들어서 시각적 피드백 제공
            chipElement.style.animation = 'chipShake 0.5s ease-in-out';
            setTimeout(() => {
                chipElement.style.animation = '';
            }, 500);
            return;
        }
        
        if (chipElement.classList.contains('clicked') || chipElement.classList.contains('collected')) {
            console.log('이미 수집된 칩입니다');
            return;
        }
        
        chipElement.classList.add('clicked');
        
        // 클라이언트 측 변수 업데이트
        myCollectedChipIndex = chipIndex;
        
        // 서버에 칩 가져가기 액션 전송 (올바른 이벤트명 사용)
        socket.emit('playerAction', {
            roomId: gameState.roomId,
            action: 'takeFromCenter',
            targetId: gameState.centerChips[chipIndex].id
        });
        
        setTimeout(() => {
            chipElement.classList.remove('clicked');
            chipElement.classList.add('collected');
            // 가져간 칩은 완전히 숨김
            chipElement.style.display = 'none';
            chipElement.style.pointerEvents = 'none';
            
            // 즉시 UI 업데이트 (서버 응답을 기다리지 않고)
            if (gameState && gameState.players) {
                const currentUsername = socket.data?.username || localStorage.getItem('username') || 
                                       sessionStorage.getItem('username') || window.currentUser;
                const myPlayer = gameState.players.find(p => p.username === currentUsername);
                if (myPlayer) {
                    updateMyPlayer(myPlayer);
                }
                
                // 요약창도 즉시 업데이트하여 칩 수집 상태 반영
                updatePlayers(gameState.players);
                
                // 게임 상태도 임시로 업데이트 (서버 응답 전까지)
                if (!gameState.collectedChips) {
                    gameState.collectedChips = [];
                }
                if (!gameState.collectedChips.includes(chipIndex)) {
                    gameState.collectedChips.push(chipIndex);
                }
                
                console.log('칩 수집 후 즉시 UI 업데이트 완료, collectedChips:', gameState.collectedChips);
            }
        }, 500);
        
        showMessage(`칩 ${chipIndex + 1}을 수집했습니다!`);
    }
    
    // 카드 받기 애니메이션
    function showCardDealingAnimation() {
        const existingAnimation = document.querySelector('.card-dealing-animation');
        if (existingAnimation) {
            existingAnimation.remove();
        }
        
        const animationContainer = document.createElement('div');
        animationContainer.className = 'card-dealing-animation';
        animationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
                gap: 10px;
        `;
        
        for (let i = 0; i < 2; i++) {
            const card = document.createElement('div');
            card.className = 'dealing-card';
            card.style.cssText = `
                width: 60px;
                height: 90px;
                background: linear-gradient(45deg, #2c3e50, #34495e);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateY(-100px);
                opacity: 0;
                transition: all 0.6s ease-out;
                border: 2px solid #fff;
            `;
            
            card.innerHTML = `
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 24px;
                    color: #fff;
                    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                ">♠</div>
            `;
            
            animationContainer.appendChild(card);
        }
        
        document.body.appendChild(animationContainer);
        
        setTimeout(() => {
            const cards = animationContainer.querySelectorAll('.dealing-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.transform = 'translateY(0)';
                    card.style.opacity = '1';
                }, index * 200);
            });
        }, 100);
        
        setTimeout(() => {
            if (animationContainer.parentNode) {
                animationContainer.remove();
            }
        }, 3000);
    }
    
    window.addEventListener('load', async () => {
        // 버전 정보 출력 (캐시 확인용)
        console.log('=== 게임 페이지 v2.1 로드됨 ===');
        console.log('Current URL:', window.location.href);
        console.log('URL Params:', window.location.search);
        
        console.log('Room ID from URL:', urlParams.get('roomId'));
        console.log('🔧 existingCollectedChips 에러 수정됨');
        console.log('수정된 handleChipClick 함수:', typeof handleChipClick);
        console.log('칩 색상 적용 여부 확인 중...');
        
        // 초기 플레이어 수는 실제 게임 상태에서 가져옴
        console.log('플레이어 수는 게임 상태 업데이트에서 설정됩니다.');
        
        
        // 로비로 돌아가기 버튼 이벤트 추가
        const backToLobbyBtn = document.getElementById('backToLobbyBtn');
        if (backToLobbyBtn) {
            backToLobbyBtn.addEventListener('click', () => {
                console.log('로비 버튼 클릭됨');
                if (confirm('게임을 종료하고 로비로 돌아가시겠습니까?')) {
                    // 현재 방에서 나가기 (여러 방법으로 roomId 확인)
                    // urlParams는 전역에서 선언됨
                    const urlRoomId = urlParams.get('roomId');
                    const currentRoomId = gameState?.roomId || urlRoomId;
                    
                    console.log('로비로 이동 - gameState.roomId:', gameState?.roomId, 'urlRoomId:', urlRoomId, 'currentRoomId:', currentRoomId);
                    
                    if (currentRoomId) {
                        socket.emit('leaveRoom', { roomId: currentRoomId });
                    }
                    
                    // 로비로 이동
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 100);
                }
            });
            
            // 추가적인 onclick 핸들러 (백업용)
            backToLobbyBtn.onclick = () => {
                console.log('로비 버튼 onclick 핸들러 호출됨');
            };
        }
        
        // 초기 게임 상태 설정
        gameState.phase = 'playing';
        updateControls();
        console.log('초기 게임 상태 설정 완료');
        
        // URL에서 roomId 가져와서 gameState에 설정
        // urlParams는 전역에서 선언됨
        const roomId = urlParams.get('roomId');
        if (roomId) {
            gameState.roomId = roomId;
            console.log('페이지 로드 시 roomId 설정:', roomId);
        }
        
        connectSocket();
        
        // 관리자 권한 확인
        isAdmin = await checkAdminStatus();
        console.log('관리자 권한 확인 결과:', isAdmin);
        
        // 게임 시작은 registerUserSuccess 이벤트에서 처리됨
        console.log('페이지 로드 완료, 사용자 등록 대기 중...');
        
        // 게임 자동 시작은 registerUserSuccess 이벤트에서 처리됨
        console.log('사용자 등록 완료 대기 중... (registerUserSuccess 이벤트에서 게임 시작)');
        
        // 초기 칩 표시 (기본값 2개, 수집된 칩 없음)
        console.log('페이지 로드 시 초기 칩 표시');
        // updateCasinoChips(2, []); // 비활성화: updateCenterChips 사용
        
        // 칩 색상 확인
        setTimeout(() => {
            const chipElements = document.querySelectorAll('.casino-chip');
            if (chipElements.length > 0) {
                const chipStyle = window.getComputedStyle(chipElements[0]);
                console.log('칩 배경색:', chipStyle.background);
                console.log('칩 요소 개수:', chipElements.length);
            } else {
                console.log('칩 요소를 찾을 수 없음');
            }
        }, 1000);
    });
    </script>
</body>
</html> 



